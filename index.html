<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migraine Predictor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #242424 100%);
            min-height: 100vh;
            color: #d5d5d5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #d5d5d5;
        }

        /* Frequency Scale */
        .frequency-scale {
            margin-bottom: 30px;
        }

        .frequency-scale h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #b5b5b5;
        }

        .frequency-options {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        .frequency-option {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }

        .frequency-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .frequency-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .frequency-option.freq-1 { background: linear-gradient(135deg, #22c55e, #86efac); color: #166534; }
        .frequency-option.freq-2 { background: linear-gradient(135deg, #84cc16, #bef264); color: #3f6212; }
        .frequency-option.freq-3 { background: linear-gradient(135deg, #eab308, #fde047); color: #854d0e; }
        .frequency-option.freq-4 { background: linear-gradient(135deg, #f97316, #fdba74); color: #9a3412; }
        .frequency-option.freq-5 { background: linear-gradient(135deg, #ef4444, #fca5a5); color: #991b1b; }
        .frequency-option.freq-6 { background: linear-gradient(135deg, #1f1f1f, #404040); color: white; }

        /* Migraine Index Display */
        .migraine-index {
            background: #353535;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .migraine-index h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #c5c5c5;
        }

        .index-value {
            font-size: 64px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .index-scale {
            position: relative;
            height: 30px;
            background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .index-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #e0e0e0;
            border: 3px solid #2a2a2a;
            border-radius: 50%;
            top: 5px;
            transform: translateX(-50%);
            transition: left 0.5s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .index-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a0a0a0;
        }

        /* Visual Break */
        .visual-break {
            height: 2px;
            background: linear-gradient(to right, transparent, #999, transparent);
            margin: 30px 0;
        }

        /* Advanced Mode */
        .advanced-mode {
            margin-bottom: 30px;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            background: #3a3a3a;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .advanced-toggle:hover {
            background: #454545;
        }

        .advanced-toggle span {
            font-size: 20px;
            margin-right: 10px;
            transition: transform 0.3s;
        }

        .advanced-toggle.open span {
            transform: rotate(45deg);
        }

        .advanced-content {
            display: none;
            padding: 20px;
            background: #323232;
            border-radius: 0 0 8px 8px;
        }

        .advanced-content.show {
            display: block;
        }

        .advanced-item {
            margin-bottom: 25px;
            padding-top: 20px;
            border-top: 1px solid #3a3a3a;
        }

        .advanced-item:first-child {
            border-top: none;
            padding-top: 0;
        }

        .advanced-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #c5c5c5;
        }

        .yes-no-buttons {
            display: flex;
            gap: 10px;
        }

        .yes-no-buttons button {
            flex: 1;
            padding: 10px;
            border: 2px solid #555;
            background: #404040;
            color: #d5d5d5;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .yes-no-buttons button:hover {
            background: #4a4a4a;
        }

        .yes-no-buttons button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"].sleep-slider {
            background: #d0d0d0;
        }

        input[type="range"].plain-slider {
            background: #d0d0d0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider-value {
            font-weight: bold;
            font-size: 18px;
            min-width: 30px;
            text-align: center;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #555;
            border-radius: 5px;
            background: #404040;
            color: #d5d5d5;
            font-size: 14px;
            cursor: pointer;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #555;
            border-radius: 5px;
            background: #404040;
            color: #d5d5d5;
            font-size: 14px;
        }

        .sub-question {
            margin-top: 15px;
            padding-left: 20px;
            display: none;
        }

        .sub-question.show {
            display: block;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #666;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin-left: 5px;
            cursor: help;
            position: relative;
        }

        .info-icon:hover .tooltip {
            display: block;
        }

        .tooltip {
            display: none;
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            width: 250px;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        /* Thin Grey Line */
        .thin-line {
            height: 1px;
            background: #999;
            margin: 30px 0;
        }

        /* Factor Displays */
        .factors-section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #c5c5c5;
        }

        .factor-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #353535;
            border-radius: 8px;
        }

        .factor-item.greyed-out {
            background: #2a2a2a;
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .factor-item.greyed-out:hover {
            opacity: 0.7;
        }

        .factor-item.greyed-out .factor-value {
            font-style: italic;
            color: #888;
        }

        .factor-prompt {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }

        /* Subcategory styles */
        .factor-subcategories {
            margin-top: 15px;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .factor-subcategory {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #555;
        }

        .factor-subcategory .factor-name {
            font-size: 14px;
            color: #b5b5b5;
        }

        /* Half-width factor with graph */
        .factor-split {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .factor-split-left {
            flex: 1;
            min-width: 0;
        }

        .factor-split-right {
            flex: 1;
            min-width: 0;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .factor-name {
            font-weight: 500;
            color: #d5d5d5;
        }

        .factor-value-container {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .factor-value-label {
            font-size: 11px;
            color: #999;
        }

        .factor-value {
            font-weight: bold;
            color: #d5d5d5;
        }

        .factor-value-underline {
            height: 1px;
            background-color: #ccc;
            margin-top: 5px;
        }

        .factor-scale {
            position: relative;
            height: 15px;
            background: linear-gradient(to right, #86efac, #fde047, #fca5a5);
            border-radius: 8px;
            cursor: pointer;
        }

        .factor-item.greyed-out .factor-scale {
            background: #d0d0d0;
        }

        /* Greyscale certain factors */
        .factor-item.factor-alcohol .factor-scale,
        .factor-item.factor-exercise .factor-scale,
        .factor-item.factor-marijuana .factor-scale {
            background: linear-gradient(to right, #d5d5d5, #888, #444);
        }

        .factor-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #333;
            border: 2px solid white;
            border-radius: 50%;
            top: 1.5px;
            transform: translateX(-50%);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .factor-item.greyed-out .factor-marker {
            background: #999;
        }

        .factor-marker-tooltip {
            display: none;
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            width: 200px;
            font-size: 12px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: pre-line;
            pointer-events: none;
        }

        .factor-marker:hover .factor-marker-tooltip,
        .factor-scale:hover .factor-marker-tooltip,
        .factor-header:hover .factor-marker-tooltip {
            display: block;
        }

        .factor-marker-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .pressure-trend {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .pressure-trend.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .pressure-trend.alert {
            background: #fee2e2;
            color: #991b1b;
        }

        .pressure-trend.stable {
            background: #dcfce7;
            color: #166534;
        }

        /* Sleep Quality Block Scale */
        .sleep-block-scale {
            display: flex;
            gap: 1px;
            height: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .sleep-block {
            flex: 1;
            position: relative;
        }

        .sleep-block.red {
            background: #fca5a5;
        }

        .sleep-block.yellow {
            background: #fde047;
        }

        .sleep-block.green {
            background: #86efac;
        }

        .sleep-block.grey {
            background: #d0d0d0;
        }

        .sleep-block.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Location Input Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #555;
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: #d5d5d5;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: #b5b5b5;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #555;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 16px;
            background: #353535;
            color: #d5d5d5;
        }

        .modal-content button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-content button:hover {
            background: #45a049;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-bottom: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #b5b5b5;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            /* Stack frequency buttons on mobile */
            .frequency-options {
                flex-direction: column;
                gap: 10px;
            }

            .frequency-option {
                padding: 12px;
                font-size: 14px;
            }

            /* Adjust migraine index display */
            .migraine-index {
                padding: 20px 15px;
            }

            .migraine-index h2 {
                font-size: 16px;
            }

            #indexValue {
                font-size: 48px;
            }

            /* Make advanced mode button full width */
            button {
                font-size: 14px;
                padding: 12px;
            }

            /* Adjust slider containers */
            .slider-container {
                font-size: 12px;
            }

            /* Stack red wine/beer checkboxes */
            .advanced-item > div[style*="display: flex; gap: 20px"] {
                flex-direction: column !important;
                gap: 10px !important;
            }

            /* Adjust caffeine calculator grid */
            .advanced-item > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            /* Factor items responsive */
            .factor-item {
                margin-bottom: 15px;
            }

            .factor-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .factor-value-container {
                margin-top: 5px;
            }

            /* Tooltips positioning on mobile */
            .tooltip {
                width: 200px;
                font-size: 11px;
                left: auto;
                right: 0;
                transform: none;
            }

            .info-icon {
                width: 16px;
                height: 16px;
                font-size: 11px;
                line-height: 16px;
            }

            /* Modal adjustments */
            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .modal-content h2 {
                font-size: 18px;
            }

            /* Location display wrapping */
            .factors-section h2 {
                flex-wrap: wrap;
                font-size: 16px;
            }

            #locationDisplay {
                display: block;
                margin-left: 0 !important;
                margin-top: 5px;
                font-size: 12px !important;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .frequency-option {
                font-size: 13px;
                padding: 10px;
            }

            #indexValue {
                font-size: 36px;
            }

            .container {
                padding: 10px;
            }

            .advanced-item label {
                font-size: 14px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Migraine Predictor</h1>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            Loading weather data
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Frequency Scale -->
            <div class="frequency-scale">
                <h2>How often do you typically experience migraines?</h2>
                <div class="frequency-options">
                    <div class="frequency-option freq-1 selected" data-freq="1" onclick="selectFrequency(1)">
                        <div>1</div>
                        <div style="font-size: 11px; margin-top: 5px;">0-1 per month</div>
                    </div>
                    <div class="frequency-option freq-2" data-freq="2" onclick="selectFrequency(2)">
                        <div>2</div>
                        <div style="font-size: 11px; margin-top: 5px;">1-2 per month</div>
                    </div>
                    <div class="frequency-option freq-3" data-freq="3" onclick="selectFrequency(3)">
                        <div>3</div>
                        <div style="font-size: 11px; margin-top: 5px;">2-4 per month</div>
                    </div>
                    <div class="frequency-option freq-4" data-freq="4" onclick="selectFrequency(4)">
                        <div>4</div>
                        <div style="font-size: 11px; margin-top: 5px;">4-5 per month</div>
                    </div>
                    <div class="frequency-option freq-5" data-freq="5" onclick="selectFrequency(5)">
                        <div>5</div>
                        <div style="font-size: 11px; margin-top: 5px;">5+ per month</div>
                    </div>
                    <div class="frequency-option freq-6" data-freq="6" onclick="selectFrequency(6)">
                        <div>ðŸ’€</div>
                        <div style="font-size: 11px; margin-top: 5px;">10+ per month</div>
                    </div>
                </div>
            </div>

            <!-- Migraine Index Display -->
            <div class="migraine-index">
                <h2>Migraine Risk Prediction (Next 12 Hours)</h2>
                <div class="index-value" id="indexValue">--</div>
                <div class="index-scale">
                    <div class="index-marker" id="indexMarker"></div>
                </div>
                <div class="index-labels">
                    <span>Low (0)</span>
                    <span>Moderate (50)</span>
                    <span>High (100)</span>
                </div>
                <div id="riskLevelText" style="margin-top: 20px; font-size: 16px; font-weight: 500; text-align: center; color: #555;"></div>
            </div>

            <!-- 12-Hour Prediction Graph -->
            <div id="predictionGraphSection" style="margin: 30px auto; padding: 25px; background: #1e1e1e; border-radius: 8px; max-width: 800px; display: none;">
                <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #e0e0e0; text-align: center;">12-Hour Migraine Risk Forecast</h3>
                <div id="predictionGraphContainer" style="display: flex; justify-content: center; align-items: center; min-height: 100px;">
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #888; text-align: center;">
                    Predicted risk based on forecast weather and your current personal factors
                </div>
            </div>

            <!-- Visual Break -->
            <div class="visual-break"></div>

            <!-- Advanced Mode -->
            <div class="advanced-mode">
                <div class="advanced-toggle" onclick="toggleAdvanced()">
                    <span>+</span>
                    <strong>Advanced Mode</strong>
                </div>
                <div class="advanced-content" id="advancedContent">
                    <!-- Food Intake -->
                    <div class="advanced-item">
                        <label>
                            I ate today
                            <span class="info-icon">?
                                <span class="tooltip">Skipping meals is a common migraine trigger due to blood sugar drops. Certain foods are also triggers: TYRAMINE (aged cheese, cured meats, pickled foods) dilates blood vessels; PHENYLETHYLAMINE (chocolate) affects neurotransmitters; NITRITES/NITRATES (processed meats) dilate vessels; HISTAMINES (citrus, fermented foods) trigger inflammation; SULFITES (pickled foods, wine) are preservatives that trigger some; ASPARTAME (sugar-free products) is an excitatory neurotransmitter; MSG & HIGH SALT (processed snacks) affect blood pressure and neurons. Not everyone reacts to all triggers.</span>
                            </span>
                        </label>
                        <div class="yes-no-buttons">
                            <button onclick="setAteToday(false)" class="active">No</button>
                            <button onclick="setAteToday(true)">Yes</button>
                        </div>
                        <div class="sub-question" id="foodDetailsQuestion">
                            <label>
                                Estimated calories consumed
                                <span class="info-icon">?
                                    <span class="tooltip">Adults typically need 1,600-3,000 calories per day depending on age, sex, and activity level. Inadequate caloric intake can trigger migraines through blood sugar fluctuations.</span>
                                </span>
                            </label>
                            <input type="number" id="caloriesInput" placeholder="e.g., 1800" min="0" onchange="updateFoodIntake()" style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="proteinCheckbox" onchange="updateFoodIntake()" style="width: auto; padding: 0;">
                                <label for="proteinCheckbox" style="margin: 0;">
                                    This included sufficient protein
                                    <span class="info-icon">?
                                        <span class="tooltip">Adults need 0.8-1.2g of protein per kg of body weight daily (46-56g minimum for most adults). Protein helps stabilize blood sugar and may reduce migraine frequency.</span>
                                    </span>
                                </label>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                                <label style="font-size: 14px; margin-bottom: 10px; color: #b5b5b5;">Including:</label>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="chocolateCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="chocolateCheckbox" style="margin: 0; font-size: 14px;">
                                            Chocolate <span style="font-size: 11px; color: #888;">(no really)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">It's often a combo trigger of caffeine, tyramine, and phenylethylamine. Not universal, but a common trigger. Some find dark chocolate more problematic than milk chocolate.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="agedCheeseCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="agedCheeseCheckbox" style="margin: 0; font-size: 14px;">
                                            Aged Cheese <span style="font-size: 11px; color: #888;">(e.g. cheddar, blue, parmesan)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">These contain tyramine, which can dilate blood vessels and mess with neurotransmitter balance. The longer cheese is aged, the higher the tyramine content. Fresh cheeses like mozzarella are generally safer.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="curedMeatsCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="curedMeatsCheckbox" style="margin: 0; font-size: 14px;">
                                            Cured or Deli Meats <span style="font-size: 11px; color: #888;">(e.g. salami, pepperoni, hot dogs, bacon)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">These contain tyramine (which can dilate blood vessels and affect neurotransmitters), as well as nitrates and nitrites (preservatives that can dilate blood vessels and start the migraine pain cascade). Processed meats are double trouble.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="pickledFoodCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="pickledFoodCheckbox" style="margin: 0; font-size: 14px;">
                                            Pickled Food <span style="font-size: 11px; color: #888;">(e.g. pickles, sauerkraut, kimchi)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">Pickled and fermented foods contain sulfites (preservatives) and tyramine. Sulfites can trigger migraines in sensitive individuals. The pickling process also increases tyramine content.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="candyCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="candyCheckbox" style="margin: 0; font-size: 14px;">
                                            Candy <span style="font-size: 11px; color: #888;">(especially sugar-free: gum, mints, diet products)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">Aspartame (artificial sweetener) can trigger migraines in sensitive individuals through excitatory neurotransmitter effects. Common in "sugar-free" products like diet sodas, sugar-free gum, and "lite" yogurts. Regular sugar isn't great either due to blood sugar spikes.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="saltySnacksCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="saltySnacksCheckbox" style="margin: 0; font-size: 14px;">
                                            Salty Snacks <span style="font-size: 11px; color: #888;">(e.g. chips, Doritos, instant noodles, fast food)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">High salt intake can increase blood pressure and trigger migraines. MSG (monosodium glutamate) is an excitatory neurotransmitter that can trigger migraines. Common in chips, instant noodles, Chinese takeout, and processed foods. Watch for "natural flavoring" which often contains MSG.</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="citrusFruitCheckbox" onchange="updateFoodTriggers()" style="width: auto; padding: 0;">
                                        <label for="citrusFruitCheckbox" style="margin: 0; font-size: 14px;">
                                            Citrus Fruits <span style="font-size: 11px; color: #888;">(oranges, lemons, grapefruit)</span>
                                            <span class="info-icon">?
                                                <span class="tooltip">Citrus fruits contain histamine, which can affect some migraine sufferers. This is a less common trigger than others. Many people with migraines can eat citrus without issues.</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hydration -->
                    <div class="advanced-item">
                        <label>
                            I drank fluids today
                            <span class="info-icon">?
                                <span class="tooltip">Dehydration is a well-known migraine trigger. Even mild dehydration (1-2% body weight loss) can trigger headaches and migraines in susceptible individuals.</span>
                            </span>
                        </label>
                        <div class="yes-no-buttons">
                            <button onclick="setDrankToday(false)" class="active">No</button>
                            <button onclick="setDrankToday(true)">Yes</button>
                        </div>
                        <div class="sub-question" id="hydrationDetailsQuestion">
                            <div style="margin-bottom: 15px;">
                                <label style="font-size: 14px; margin-bottom: 5px; display: block;">
                                    Total fluid intake (fl oz)
                                    <span class="info-icon">?
                                        <span class="tooltip">Adults need approximately 64-100 fl oz (8-12 cups) of fluids per day, varying by body size, activity level, and climate. Adequate hydration helps prevent migraines.</span>
                                    </span>
                                </label>
                                <input type="number" id="fluidOzInput" placeholder="e.g., 64" min="0" onchange="updateHydration()" style="width: 100%;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="waterCheckbox" onchange="updateHydration()" style="width: auto; padding: 0;">
                                <label for="waterCheckbox" style="margin: 0;">
                                    At least some of this was water
                                    <span class="info-icon">?
                                        <span class="tooltip">While all fluids contribute to hydration, water is the most effective. Caffeinated and alcoholic beverages may have diuretic effects that can contribute to dehydration.</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Stress Level -->
                    <div class="advanced-item">
                        <label>
                            Stress level today
                            <span class="info-icon">?
                                <span class="tooltip">Stress increases cortisol production, which can cause inflammation and brain sensitivity, triggering migraines. However, high stress doesn't guarantee a migraine.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span>0</span>
                            <input type="range" min="0" max="10" value="0" id="stressSlider" oninput="updateStress(this.value)">
                            <span>10</span>
                            <span class="slider-value" id="stressValue">0</span>
                        </div>
                    </div>

                    <!-- Sleep Quality -->
                    <div class="advanced-item">
                        <label>
                            Hours of sleep last night
                            <span class="info-icon">?
                                <span class="tooltip">Poor sleep increases oxidative stress in the brain and elevates cortisol, both of which can trigger migraines. Both too little and too much sleep are triggers. Optimal is 7-8 hours.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span>0 hrs</span>
                            <input type="range" min="0" max="15" step="0.5" value="7" id="sleepSlider" class="sleep-slider" oninput="updateSleep(this.value)">
                            <span>15+ hrs</span>
                            <span class="slider-value" id="sleepValue">7 hrs</span>
                        </div>

                        <!-- Sleep Quality Subquestion -->
                        <div style="margin-top: 15px; padding-left: 20px; border-left: 2px solid #444;">
                            <label style="font-size: 14px; color: #b5b5b5; display: block; margin-bottom: 8px;">
                                How was the quality?
                            </label>
                            <select id="sleepQualitySelect" onchange="updateSleepQuality()" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;">
                                <option value="" selected>Select...</option>
                                <option value="0">Awful - What is sleep anyway?</option>
                                <option value="1">Terrible - Tossed and turned all night</option>
                                <option value="2">Meh - Slept... I guess?</option>
                                <option value="3">Decent - Not bad, not great</option>
                                <option value="4">Good - Actually rested!</option>
                                <option value="5">Excellent - Like a baby!</option>
                            </select>
                        </div>
                    </div>

                    <!-- Caffeine Intake -->
                    <div class="advanced-item">
                        <label>
                            Caffeine intake today
                            <span class="info-icon">?
                                <span class="tooltip">Caffeine has a complex relationship with migraines - it can help treat them but overuse or withdrawal can trigger them. Regular users may experience withdrawal headaches. 1 cup coffee â‰ˆ 95mg, 1 energy drink â‰ˆ 80-150mg.</span>
                            </span>
                        </label>
                        <select id="caffeineSelect" onchange="updateCaffeine()">
                            <option value="" selected>Select...</option>
                            <option value="0">None - Caffeine? Never heard of her (0 mg)</option>
                            <option value="25">Barely Awake (25-50 mg)</option>
                            <option value="75">Sipping Gently (75-100 mg)</option>
                            <option value="125">One Cup Wonder (125-150 mg)</option>
                            <option value="175">Casually Caffeinated (175-200 mg)</option>
                            <option value="225">Getting Serious (225-250 mg)</option>
                            <option value="275">Double-Fisting (275-300 mg)</option>
                            <option value="350">Productivity Mode (350-400 mg)</option>
                            <option value="450">Vibrating Slightly (450-500 mg)</option>
                            <option value="550">Can Taste Colors (550-600 mg)</option>
                            <option value="650">Questioning Reality (650-700 mg)</option>
                            <option value="750">Hummingbird Heart Rate (750-800 mg)</option>
                            <option value="850">Transcending This Plane (850-900 mg)</option>
                            <option value="950">Communicating with Coffee Gods (950-1000 mg)</option>
                            <option value="1000">1000+ mg (Please Seek Help)</option>
                        </select>
                        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="regularCaffeineCheckbox" onchange="toggleRegularCaffeine()" style="width: auto; padding: 0;">
                            <label for="regularCaffeineCheckbox" style="margin: 0;">
                                I regularly consume caffeine
                            </label>
                        </div>
                        <div id="caffeineComparisonSection" style="margin-top: 15px; display: none;">
                            <label style="margin-bottom: 5px; display: block;">Today's intake is:</label>
                            <select id="caffeineComparisonSelect" onchange="updateCaffeineComparison()">
                                <option value="below">Below my usual intake</option>
                                <option value="equal" selected>Equal to my usual intake</option>
                                <option value="above">Above my usual intake</option>
                            </select>
                        </div>
                        <!-- Optional Caffeine Calculator -->
                        <div style="margin-top: 15px; padding: 15px; border: 1px solid #555; border-radius: 8px; background-color: #353535;">
                            <div style="font-size: 13px; color: #b5b5b5; margin-bottom: 10px; font-style: italic;">
                                ðŸ’¡ Optional Caffeine Calculator (auto-fills "Caffeine intake today" above)
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="font-size: 14px; margin-bottom: 5px;">
                                        Cups of coffee
                                        <span class="info-icon">?
                                            <span class="tooltip">1 cup of coffee contains approximately 95mg of caffeine. This helps track your exact caffeine intake.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="coffeeCupsInput" min="0" max="20" value="0" placeholder="0" onchange="updateCaffeineDetails()" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 14px; margin-bottom: 5px;">
                                        Energy drinks
                                        <span class="info-icon">?
                                            <span class="tooltip">Energy drinks typically contain 80-150mg of caffeine per can. Common brands: Red Bull (80mg), Monster (160mg), Bang (300mg).</span>
                                        </span>
                                    </label>
                                    <input type="number" id="energyDrinksInput" min="0" max="20" value="0" placeholder="0" onchange="updateCaffeineDetails()" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 14px; margin-bottom: 5px;">
                                        Cups of strong tea
                                        <span class="info-icon">?
                                            <span class="tooltip">1 cup of strong black tea contains approximately 50mg of caffeine. Green tea contains about 30mg per cup.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="teaCupsInput" min="0" max="20" value="0" placeholder="0" onchange="updateCaffeineDetails()" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 14px; margin-bottom: 5px;">
                                        Caffeine via meds (mg)
                                        <span class="info-icon">?
                                            <span class="tooltip">Some medications contain caffeine. Common examples: Excedrin (65mg), Midol (60mg), Anacin (32mg). Check your medication label.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="caffeineMedsInput" min="0" max="500" value="0" placeholder="0" onchange="updateCaffeineDetails()" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alcohol Consumption -->
                    <div class="advanced-item">
                        <label>
                            Alcohol (last 24 hours)
                            <span class="info-icon">?
                                <span class="tooltip">Alcohol is a well-known migraine trigger. It causes vasodilation, dehydration, and can disrupt sleep. Red wine and beer are common triggers due to histamines and tyramine.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span>0</span>
                            <input type="range" min="0" max="12" step="1" value="0" id="alcoholSlider" class="plain-slider" oninput="updateAlcohol(this.value)">
                            <span>12</span>
                            <span class="slider-value" id="alcoholValue">0 drinks</span>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="redWineCheckbox" onchange="toggleRedWine()" style="width: auto; padding: 0;">
                                <label for="redWineCheckbox" style="margin: 0; font-size: 14px;">Consumed red wine</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="beerCheckbox" onchange="toggleBeer()" style="width: auto; padding: 0;">
                                <label for="beerCheckbox" style="margin: 0; font-size: 14px;">Consumed beer</label>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="regularAlcoholCheckbox" onchange="toggleRegularAlcohol()" style="width: auto; padding: 0;">
                            <label for="regularAlcoholCheckbox" style="margin: 0;">I regularly consume alcohol</label>
                        </div>
                        <div id="alcoholComparisonSection" style="display: none; margin-top: 10px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">Today's Intake Is</label>
                            <select id="alcoholComparisonSelect" onchange="updateAlcoholComparison()">
                                <option value="less">Less than usual</option>
                                <option value="equal" selected>The same as usual</option>
                                <option value="more">More than usual</option>
                                <option value="farmore">FAR more than usual</option>
                            </select>
                        </div>
                    </div>

                    <!-- Exercise -->
                    <div class="advanced-item">
                        <label>
                            Exercise (last 24 hours)
                            <span class="info-icon">?
                                <span class="tooltip">Moderate exercise can help prevent migraines by reducing stress and improving circulation. However, intense exercise can trigger migraines in some people through dehydration or blood pressure changes.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span style="font-size: 11px;">None</span>
                            <input type="range" min="0" max="3" step="1" value="0" id="exerciseSlider" class="plain-slider" oninput="updateExercise(this.value)">
                            <span style="font-size: 11px;">Heavy</span>
                            <span class="slider-value" id="exerciseValue">None</span>
                        </div>
                        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="regularExerciseCheckbox" onchange="toggleRegularExercise()" style="width: auto; padding: 0;">
                            <label for="regularExerciseCheckbox" style="margin: 0;">I regularly exercise</label>
                        </div>
                        <div id="exerciseComparisonSection" style="display: none; margin-top: 10px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">Today's Exercise Is</label>
                            <select id="exerciseComparisonSelect" onchange="updateExerciseComparison()">
                                <option value="less">Less than usual</option>
                                <option value="equal" selected>The same as usual</option>
                                <option value="more">More than usual</option>
                                <option value="farmore">FAR more than usual</option>
                            </select>
                        </div>
                    </div>

                    <!-- Light Exposure -->
                    <div class="advanced-item">
                        <label>Light exposure today</label>
                        <div style="margin-top: 10px; padding-left: 20px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">
                                Direct sunlight (hours)
                                <span class="info-icon">?
                                    <span class="tooltip">Bright sunlight can trigger migraines in photosensitive individuals. UV exposure and glare are common triggers.</span>
                                </span>
                            </label>
                            <div class="slider-container" style="margin-bottom: 15px;">
                                <span>0</span>
                                <input type="range" min="0" max="24" step="0.5" value="0" id="sunlightSlider" oninput="updateSunlight(this.value)">
                                <span>24</span>
                                <span class="slider-value" id="sunlightValue">0 hrs</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding-left: 20px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">
                                Fluorescent light (hours)
                                <span class="info-icon">?
                                    <span class="tooltip">Fluorescent lighting flickers at a frequency that can trigger migraines in sensitive individuals. Office environments often have prolonged fluorescent exposure.</span>
                                </span>
                            </label>
                            <div class="slider-container" style="margin-bottom: 15px;">
                                <span>0</span>
                                <input type="range" min="0" max="24" step="0.5" value="0" id="fluorescentSlider" oninput="updateFluorescent(this.value)">
                                <span>24</span>
                                <span class="slider-value" id="fluorescentValue">0 hrs</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding-left: 20px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">
                                Screen light (hours)
                                <span class="info-icon">?
                                    <span class="tooltip">Prolonged screen exposure can cause eye strain and trigger migraines, particularly with bright screens or blue light exposure. Screens emit blue light which can be particularly triggering.</span>
                                </span>
                            </label>
                            <div class="slider-container">
                                <span>0</span>
                                <input type="range" min="0" max="24" step="0.5" value="0" id="screenSlider" oninput="updateScreen(this.value)">
                                <span>24</span>
                                <span class="slider-value" id="screenValue">0 hrs</span>
                            </div>
                        </div>
                    </div>

                    <!-- Strong Scents -->
                    <div class="advanced-item">
                        <label>
                            Exposure to strong scents (hours)
                            <span class="info-icon">?
                                <span class="tooltip">Strong smells (perfumes, cleaning products, smoke, paint fumes) can trigger migraines in sensitive individuals through trigeminal nerve stimulation.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span>0</span>
                            <input type="range" min="0" max="24" step="0.5" value="0" id="scentsSlider" oninput="updateScents(this.value)">
                            <span>24</span>
                            <span class="slider-value" id="scentsValue">0 hrs</span>
                        </div>
                    </div>

                    <!-- Marijuana Consumption -->
                    <div class="advanced-item">
                        <label>
                            Marijuana (last 24 hours)
                            <span class="info-icon">?
                                <span class="tooltip">Marijuana's relationship with migraines is complex. Some find relief, while others experience triggers. THC can affect blood pressure and hydration. Individual responses vary significantly.</span>
                            </span>
                        </label>
                        <div class="slider-container">
                            <span>0</span>
                            <input type="range" min="0" max="12" step="1" value="0" id="marijuanaSlider" class="plain-slider" oninput="updateMarijuana(this.value)">
                            <span>12</span>
                            <span class="slider-value" id="marijuanaValue">0 sessions</span>
                        </div>
                        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="regularMarijuanaCheckbox" onchange="toggleRegularMarijuana()" style="width: auto; padding: 0;">
                            <label for="regularMarijuanaCheckbox" style="margin: 0;">I regularly consume marijuana</label>
                        </div>
                        <div id="marijuanaComparisonSection" style="display: none; margin-top: 10px;">
                            <label style="font-size: 14px; margin-bottom: 5px; display: block;">Today's Intake Is</label>
                            <select id="marijuanaComparisonSelect" onchange="updateMarijuanaComparison()">
                                <option value="less">Less than usual</option>
                                <option value="equal" selected>The same as usual</option>
                                <option value="more">More than usual</option>
                                <option value="farmore">FAR more than usual</option>
                            </select>
                        </div>
                    </div>

                    <!-- Menstrual Cycle -->
                    <div class="advanced-item">
                        <label>
                            Next expected menstrual cycle (days away)
                            <span class="info-icon">?
                                <span class="tooltip">Hormonal fluctuations around menstruation are a significant migraine trigger for many people. Risk is highest 2 days before through first 3 days of menstruation.</span>
                            </span>
                        </label>
                        <select id="menstrualSelect" onchange="updateMenstrual()">
                            <option value="" selected>Select...</option>
                            <option value="not_applicable">Does not apply to me</option>
                            <option value="0">0 days (currently menstruating)</option>
                            <option value="1">1 day</option>
                            <option value="2">2 days</option>
                            <option value="3">3 days</option>
                            <option value="4">4 days</option>
                            <option value="5">5 days</option>
                            <option value="6">6 days</option>
                            <option value="7">7 days</option>
                            <option value="8">8 days</option>
                            <option value="9">9 days</option>
                            <option value="10">10 days</option>
                            <option value="11">11 days</option>
                            <option value="12">12 days</option>
                            <option value="13">13 days</option>
                            <option value="14">14 days</option>
                            <option value="15">15 days</option>
                            <option value="16">16 days</option>
                            <option value="17">17 days</option>
                            <option value="18">18 days</option>
                            <option value="19">19 days</option>
                            <option value="20">20 days</option>
                            <option value="21">21 days</option>
                            <option value="22">22 days</option>
                            <option value="23">23 days</option>
                            <option value="24">24 days</option>
                            <option value="25">25 days</option>
                            <option value="26">26 days</option>
                            <option value="27">27 days</option>
                            <option value="28">28 days</option>
                            <option value="unsure">Unsure</option>
                            <option value="pregnant">Pregnant</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Thin Grey Line -->
            <div class="thin-line"></div>

            <!-- Individual Factors -->
            <div class="factors-section">
                <h2>Environmental & Personal Factors <span id="locationDisplay" style="font-size: 14px; font-weight: normal; color: #999; margin-left: 15px;"></span></h2>
                <div id="factorsContainer"></div>
            </div>

            <!-- Feedback Link -->
            <div style="text-align: center; margin-top: 30px; padding: 20px;">
                <a href="https://forms.gle/JELAGnoehGU9BFwZA" target="_blank" style="color: #fff; text-decoration: underline; font-size: 14px;">Feedback?</a>
            </div>
        </div>
    </div>

    <!-- Location Modal -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <h2>Location Required</h2>
            <p>We need your location to fetch weather data. This information is only used to retrieve environmental conditions and is never stored or shared.</p>
            <p>Please enter your ZIP code or address:</p>
            <div class="error-message" id="locationError">Invalid location. Please try again.</div>
            <input type="text" id="locationInput" placeholder="e.g., 90210 or New York, NY">
            <button onclick="submitManualLocation()">Get Weather Data</button>
        </div>
    </div>

    <script>
        // Configuration - Add your free WeatherAPI.com API key here
        // Get one at: https://www.weatherapi.com/signup.aspx
        const WEATHER_API_KEY = 'c89e1c86b7b54a38bf600957250811';

        // Global state
        let weatherData = null;
        let userState = {
            frequency: 1,
            // Food intake
            ateToday: null,  // null means not filled out
            calories: '',
            sufficientProtein: false,
            foodTriggers: {
                chocolate: false,
                agedCheese: false,
                curedMeats: false,
                pickledFood: false,
                candy: false,
                saltySnacks: false,
                citrusFruit: false
            },
            // Hydration
            drankToday: null,  // null means not filled out
            fluidOz: '',
            includedWater: false,
            // Personal factors
            stress: null,  // null means not filled out, default shown as 0
            sleep: null,  // null means not filled out, default shown as 7
            sleepQuality: null,  // null means not filled out, 0-5 scale
            caffeine: null,  // null means not filled out, default shown as Select
            caffeineDetail: { cups: 0, energyDrinks: 0, teaCups: 0, meds: 0 },
            regularCaffeineConsumer: false,
            caffeineComparison: 'equal', // below, equal, above
            alcohol: 0,  // 0-12 drinks slider
            regularAlcoholConsumer: false,
            alcoholComparison: 'equal', // less, equal, more, farmore
            containsRedWine: false,
            containsBeer: false,
            exercise: 0,  // 0=none, 1=light, 2=moderate, 3=heavy slider
            regularExerciser: false,
            exerciseComparison: 'equal', // less, equal, more, farmore
            marijuana: 0,  // 0-12 sessions slider
            regularMarijuanaConsumer: false,
            marijuanaComparison: 'equal', // less, equal, more, farmore
            lightExposure: { sunlight: 0, fluorescent: 0, screen: 0 },
            scents: 0,
            // Menstrual cycle
            menstrualDays: null,  // null means not filled out
            menstrualNotApplicable: false,
            menstrualLastUpdated: null,  // Track when menstrual data was last set
            // Tracking which fields have been modified
            filledFields: {
                food: false,
                hydration: false,
                stress: false,
                sleep: false,
                caffeine: false,
                alcohol: false,
                exercise: false,
                marijuana: false,
                lightExposure: false,
                scents: false,
                menstrual: false
            }
        };

        // Load preferences on app start
        window.addEventListener('DOMContentLoaded', function() {
            loadUserPreferences();
            initializeApp();
        });

        function saveUserPreferences() {
            // Only save frequency and menstrual cycle data
            const toSave = {
                frequency: userState.frequency,
                menstrualDays: userState.menstrualDays,
                menstrualNotApplicable: userState.menstrualNotApplicable,
                menstrualLastUpdated: userState.menstrualLastUpdated
            };
            localStorage.setItem('userPreferences', JSON.stringify(toSave));
        }

        function loadUserPreferences() {
            const saved = localStorage.getItem('userPreferences');
            if (saved) {
                const loaded = JSON.parse(saved);

                // Load frequency
                if (loaded.frequency) {
                    userState.frequency = loaded.frequency;
                }

                // Load and auto-update menstrual cycle data
                if (loaded.menstrualNotApplicable !== undefined) {
                    userState.menstrualNotApplicable = loaded.menstrualNotApplicable;
                }

                if (loaded.menstrualDays !== null && loaded.menstrualLastUpdated && !loaded.menstrualNotApplicable) {
                    // Calculate days passed since last update
                    const lastUpdated = new Date(loaded.menstrualLastUpdated);
                    const now = new Date();
                    const daysPassed = Math.floor((now - lastUpdated) / (1000 * 60 * 60 * 24));

                    // Decrement menstrual days
                    let updatedDays = loaded.menstrualDays - daysPassed;

                    // If cycle has passed (went negative), reset to 28-day cycle
                    if (updatedDays < 0) {
                        // Calculate how many days into new cycle
                        updatedDays = 28 + (updatedDays % 28);
                    }

                    userState.menstrualDays = updatedDays;
                    userState.menstrualLastUpdated = now.toISOString();
                    userState.filledFields.menstrual = true;

                    // Save the updated value
                    saveUserPreferences();
                } else if (loaded.menstrualDays !== null) {
                    userState.menstrualDays = loaded.menstrualDays;
                    userState.menstrualLastUpdated = loaded.menstrualLastUpdated;
                    if (userState.menstrualDays !== null || userState.menstrualNotApplicable) {
                        userState.filledFields.menstrual = true;
                    }
                }

                applyLoadedPreferences();
            }
        }

        function applyLoadedPreferences() {
            // Apply frequency
            selectFrequency(userState.frequency);

            // Apply menstrual cycle only
            if (userState.menstrualNotApplicable) {
                document.getElementById('menstrualSelect').value = 'not_applicable';
            } else if (userState.menstrualDays !== null) {
                document.getElementById('menstrualSelect').value = userState.menstrualDays;
            }
        }

        function initializeApp() {
            document.getElementById('loadingState').style.display = 'block';
            requestLocation();
        }

        function requestLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        fetchWeatherData(`${lat},${lon}`);
                    },
                    error => {
                        // Geolocation denied, try IP-based location
                        fetchWeatherData('auto:ip');
                    }
                );
            } else {
                // Geolocation not supported, try IP-based
                fetchWeatherData('auto:ip');
            }
        }

        async function fetchWeatherData(location) {
            // Check if API key is configured
            if (WEATHER_API_KEY === 'YOUR_API_KEY_HERE') {
                document.getElementById('loadingState').innerHTML =
                    '<div style="color: #ef4444; padding: 20px;">âš ï¸ Please configure your WeatherAPI.com API key in the HTML file. Get a free key at <a href="https://www.weatherapi.com/signup.aspx" target="_blank" style="color: #2563eb;">WeatherAPI.com</a></div>';
                return;
            }

            try {
                // Fetch forecast weather data (includes current + 12hr forecast)
                const forecastResponse = await fetch(
                    `https://api.weatherapi.com/v1/forecast.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(location)}&days=1&aqi=yes&hour=12`
                );

                if (!forecastResponse.ok) {
                    if (forecastResponse.status === 400 && location === 'auto:ip') {
                        // IP location failed, show manual input
                        showLocationModal();
                        return;
                    }
                    throw new Error('Weather API request failed');
                }

                weatherData = await forecastResponse.json();

                // Update location display
                if (weatherData.location) {
                    const locationText = `Your Location: ${weatherData.location.name}, ${weatherData.location.region}`;
                    document.getElementById('locationDisplay').textContent = locationText;
                }

                // Extract forecast hours for 6hr and 12hr windows
                if (weatherData.forecast && weatherData.forecast.forecastday[0]) {
                    const forecastHours = weatherData.forecast.forecastday[0].hour;
                    const currentHour = new Date().getHours();

                    // Get next 6 hours and next 12 hours for prediction
                    weatherData.forecast6hr = forecastHours.slice(currentHour + 1, currentHour + 7);
                    weatherData.forecast12hr = forecastHours.slice(currentHour + 1, currentHour + 13);
                }

                // Fetch historical data (24 hours ago)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0]; // Format: YYYY-MM-DD

                try {
                    const historyResponse = await fetch(
                        `https://api.weatherapi.com/v1/history.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(location)}&dt=${yesterdayStr}`
                    );

                    if (historyResponse.ok) {
                        const historyData = await historyResponse.json();
                        // Add historical data to weatherData
                        weatherData.history = historyData.forecast.forecastday[0];

                        // Calculate 6-hour and 24-hour historical averages
                        const now = new Date();
                        const sixHoursAgo = new Date(now.getTime() - 6 * 60 * 60 * 1000);

                        // Get all hourly data from the last 24 hours
                        const allHours = historyData.forecast.forecastday[0].hour;

                        // Filter for 6-hour window
                        weatherData.history6hr = allHours.slice(-6); // Last 6 hours of yesterday's data
                        weatherData.history24hr = allHours; // Full 24 hours
                    }
                } catch (historyError) {
                    console.warn('Historical data not available:', historyError);
                    // Continue without historical data
                }

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                calculateAndDisplayMigraineIndex();
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.getElementById('loadingState').style.display = 'none';
                if (location === 'auto:ip') {
                    showLocationModal();
                } else {
                    document.getElementById('locationError').classList.add('show');
                }
            }
        }

        function showLocationModal() {
            document.getElementById('locationModal').classList.add('show');
        }

        function submitManualLocation() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                document.getElementById('locationError').textContent = 'Please enter a location.';
                document.getElementById('locationError').classList.add('show');
                return;
            }
            document.getElementById('locationModal').classList.remove('show');
            document.getElementById('loadingState').style.display = 'block';
            fetchWeatherData(location);
        }

        function selectFrequency(freq) {
            document.querySelectorAll('.frequency-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-freq="${freq}"]`).classList.add('selected');
            userState.frequency = freq;
            saveUserPreferences();
            if (weatherData) {
                calculateAndDisplayMigraineIndex();
            }
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggle = document.querySelector('.advanced-toggle');
            const wasHidden = !content.classList.contains('show');
            content.classList.toggle('show');
            toggle.classList.toggle('open');

            // If opening for first time, default certain factors to 0
            if (wasHidden) {
                setAdvancedModeDefaults();
            }
        }

        function openAdvancedMode() {
            const content = document.getElementById('advancedContent');
            const toggle = document.querySelector('.advanced-toggle');
            if (!content.classList.contains('show')) {
                content.classList.add('show');
                toggle.classList.add('open');
                setAdvancedModeDefaults();
            }
            // Scroll to Advanced Mode
            toggle.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function setAdvancedModeDefaults() {
            // When user opens Advanced Mode, default these factors to 0 if not yet filled
            if (!userState.filledFields.stress && userState.stress === null) {
                userState.stress = 0;
                userState.filledFields.stress = true;
            }
            if (!userState.filledFields.alcohol) {
                userState.alcohol = 0;
                userState.filledFields.alcohol = true;
            }
            if (!userState.filledFields.exercise) {
                userState.exercise = 0;
                userState.filledFields.exercise = true;
            }
            if (!userState.filledFields.marijuana) {
                userState.marijuana = 0;
                userState.filledFields.marijuana = true;
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function setAteToday(value) {
            userState.ateToday = value;
            userState.filledFields.food = true;
            const buttons = document.querySelectorAll('.advanced-item:nth-child(1) .yes-no-buttons button');
            buttons.forEach((btn, idx) => {
                btn.classList.toggle('active', (idx === 1) === value);
            });

            const subQuestion = document.getElementById('foodDetailsQuestion');
            if (value) {
                subQuestion.classList.add('show');
            } else {
                subQuestion.classList.remove('show');
                userState.calories = '';
                userState.sufficientProtein = false;
            }

            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateFoodIntake() {
            userState.calories = document.getElementById('caloriesInput').value;
            userState.sufficientProtein = document.getElementById('proteinCheckbox').checked;
            userState.filledFields.food = true;
            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateFoodTriggers() {
            userState.foodTriggers.chocolate = document.getElementById('chocolateCheckbox').checked;
            userState.foodTriggers.agedCheese = document.getElementById('agedCheeseCheckbox').checked;
            userState.foodTriggers.curedMeats = document.getElementById('curedMeatsCheckbox').checked;
            userState.foodTriggers.pickledFood = document.getElementById('pickledFoodCheckbox').checked;
            userState.foodTriggers.candy = document.getElementById('candyCheckbox').checked;
            userState.foodTriggers.saltySnacks = document.getElementById('saltySnacksCheckbox').checked;
            userState.foodTriggers.citrusFruit = document.getElementById('citrusFruitCheckbox').checked;
            userState.filledFields.food = true;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function setDrankToday(value) {
            userState.drankToday = value;
            userState.filledFields.hydration = true;
            const buttons = document.querySelectorAll('.advanced-item:nth-child(2) .yes-no-buttons button');
            buttons.forEach((btn, idx) => {
                btn.classList.toggle('active', (idx === 1) === value);
            });

            const subQuestion = document.getElementById('hydrationDetailsQuestion');
            if (value) {
                subQuestion.classList.add('show');
            } else {
                subQuestion.classList.remove('show');
                userState.fluidOz = '';
                userState.includedWater = false;
            }

            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateHydration() {
            userState.fluidOz = document.getElementById('fluidOzInput').value;
            userState.includedWater = document.getElementById('waterCheckbox').checked;
            userState.filledFields.hydration = true;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateStress(value) {
            userState.stress = parseInt(value);
            userState.filledFields.stress = true;
            document.getElementById('stressValue').textContent = value;
            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateSleep(value) {
            userState.sleep = parseFloat(value);
            userState.filledFields.sleep = true;
            document.getElementById('sleepValue').textContent = value + ' hrs';
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateSleepQuality() {
            const value = document.getElementById('sleepQualitySelect').value;
            if (value === '') {
                userState.sleepQuality = null;
            } else {
                userState.sleepQuality = parseInt(value);
            }
            userState.filledFields.sleep = true; // Mark sleep as filled when quality is set
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateCaffeine() {
            const value = document.getElementById('caffeineSelect').value;
            if (value === '') {
                userState.caffeine = null;
                userState.filledFields.caffeine = false;
            } else {
                userState.caffeine = parseInt(value);
                userState.filledFields.caffeine = true;
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleRegularCaffeine() {
            const checked = document.getElementById('regularCaffeineCheckbox').checked;
            userState.regularCaffeineConsumer = checked;
            const comparisonSection = document.getElementById('caffeineComparisonSection');
            if (checked) {
                comparisonSection.style.display = 'block';
            } else {
                comparisonSection.style.display = 'none';
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateCaffeineComparison() {
            userState.caffeineComparison = document.getElementById('caffeineComparisonSelect').value;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateCaffeineDetails() {
            const cups = parseInt(document.getElementById('coffeeCupsInput').value) || 0;
            const energyDrinks = parseInt(document.getElementById('energyDrinksInput').value) || 0;
            const teaCups = parseInt(document.getElementById('teaCupsInput').value) || 0;
            const meds = parseInt(document.getElementById('caffeineMedsInput').value) || 0;
            userState.caffeineDetail = { cups, energyDrinks, teaCups, meds };

            // Estimate caffeine: coffee=95mg, energy drink=120mg, tea=50mg, meds=direct mg
            const estimatedCaffeine = (cups * 95) + (energyDrinks * 120) + (teaCups * 50) + meds;

            // Update the select to match the estimated range
            if (estimatedCaffeine === 0) userState.caffeine = 0;
            else if (estimatedCaffeine <= 50) userState.caffeine = 25;
            else if (estimatedCaffeine <= 100) userState.caffeine = 75;
            else if (estimatedCaffeine <= 150) userState.caffeine = 125;
            else if (estimatedCaffeine <= 200) userState.caffeine = 175;
            else if (estimatedCaffeine <= 250) userState.caffeine = 225;
            else if (estimatedCaffeine <= 300) userState.caffeine = 275;
            else if (estimatedCaffeine <= 400) userState.caffeine = 350;
            else if (estimatedCaffeine <= 500) userState.caffeine = 450;
            else if (estimatedCaffeine <= 600) userState.caffeine = 550;
            else if (estimatedCaffeine <= 700) userState.caffeine = 650;
            else if (estimatedCaffeine <= 800) userState.caffeine = 750;
            else if (estimatedCaffeine <= 900) userState.caffeine = 850;
            else if (estimatedCaffeine <= 1000) userState.caffeine = 950;
            else userState.caffeine = 1000;

            document.getElementById('caffeineSelect').value = userState.caffeine;
            userState.filledFields.caffeine = true;
            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateAlcohol(value) {
            userState.alcohol = parseInt(value);
            userState.filledFields.alcohol = true;
            document.getElementById('alcoholValue').textContent = `${value} drink${value == 1 ? '' : 's'}`;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleRegularAlcohol() {
            const checked = document.getElementById('regularAlcoholCheckbox').checked;
            userState.regularAlcoholConsumer = checked;
            const comparisonSection = document.getElementById('alcoholComparisonSection');
            if (checked) {
                comparisonSection.style.display = 'block';
            } else {
                comparisonSection.style.display = 'none';
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateAlcoholComparison() {
            userState.alcoholComparison = document.getElementById('alcoholComparisonSelect').value;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleRedWine() {
            userState.containsRedWine = document.getElementById('redWineCheckbox').checked;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleBeer() {
            userState.containsBeer = document.getElementById('beerCheckbox').checked;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateExercise(value) {
            const labels = ['None', 'Light', 'Moderate', 'Heavy'];
            userState.exercise = parseInt(value);
            userState.filledFields.exercise = true;
            document.getElementById('exerciseValue').textContent = labels[value];
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleRegularExercise() {
            const checked = document.getElementById('regularExerciseCheckbox').checked;
            userState.regularExerciser = checked;
            const comparisonSection = document.getElementById('exerciseComparisonSection');
            if (checked) {
                comparisonSection.style.display = 'block';
            } else {
                comparisonSection.style.display = 'none';
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateExerciseComparison() {
            userState.exerciseComparison = document.getElementById('exerciseComparisonSelect').value;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateMarijuana(value) {
            userState.marijuana = parseInt(value);
            userState.filledFields.marijuana = true;
            document.getElementById('marijuanaValue').textContent = `${value} session${value == 1 ? '' : 's'}`;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function toggleRegularMarijuana() {
            const checked = document.getElementById('regularMarijuanaCheckbox').checked;
            userState.regularMarijuanaConsumer = checked;
            const comparisonSection = document.getElementById('marijuanaComparisonSection');
            if (checked) {
                comparisonSection.style.display = 'block';
            } else {
                comparisonSection.style.display = 'none';
            }
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateMarijuanaComparison() {
            userState.marijuanaComparison = document.getElementById('marijuanaComparisonSelect').value;
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateSunlight(value) {
            userState.lightExposure.sunlight = parseFloat(value);
            userState.filledFields.lightExposure = true;
            document.getElementById('sunlightValue').textContent = value + ' hrs';
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateFluorescent(value) {
            userState.lightExposure.fluorescent = parseFloat(value);
            userState.filledFields.lightExposure = true;
            document.getElementById('fluorescentValue').textContent = value + ' hrs';
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateScreen(value) {
            userState.lightExposure.screen = parseFloat(value);
            userState.filledFields.lightExposure = true;
            document.getElementById('screenValue').textContent = value + ' hrs';
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateScents(value) {
            userState.scents = parseFloat(value);
            userState.filledFields.scents = true;
            document.getElementById('scentsValue').textContent = value + ' hrs';
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function updateMenstrual() {
            const value = document.getElementById('menstrualSelect').value;
            userState.filledFields.menstrual = true;

            if (value === 'not_applicable' || value === 'pregnant') {
                userState.menstrualNotApplicable = true;
                userState.menstrualDays = null;
                userState.menstrualLastUpdated = null;
            } else if (value === 'unsure') {
                userState.menstrualNotApplicable = false;
                userState.menstrualDays = 15; // Assume mid-cycle
                userState.menstrualLastUpdated = new Date().toISOString();
            } else if (value === '') {
                userState.menstrualNotApplicable = false;
                userState.menstrualDays = null;
                userState.menstrualLastUpdated = null;
            } else {
                userState.menstrualNotApplicable = false;
                userState.menstrualDays = parseInt(value);
                userState.menstrualLastUpdated = new Date().toISOString();
            }

            saveUserPreferences();
            if (weatherData) calculateAndDisplayMigraineIndex();
        }

        function calculateAndDisplayMigraineIndex() {
            if (!weatherData) return;

            // Extract environmental data
            const current = weatherData.current;
            const pressure = current.pressure_mb;
            const temp = current.temp_c;
            const humidity = current.humidity;
            const windSpeed = current.wind_kph;
            const precipitation = current.precip_mm;
            const aqi = current.air_quality?.['us-epa-index'] || 1;

            // Get time-related factors
            const now = new Date();
            const hour = now.getHours();
            const dayOfWeek = now.getDay();
            const month = now.getMonth();

            // Calculate base risk scores for each factor (0-100 scale)
            const factors = {
                pressure: calculatePressureRisk(pressure, weatherData.history),
                temperature: calculateTemperatureRisk(temp, weatherData.history),
                humidity: calculateHumidityRisk(humidity),
                aqi: calculateAQIRisk(aqi),
                precipitation: calculatePrecipitationRisk(precipitation),
                wind: calculateWindRisk(windSpeed),
                time: calculateTimeRisk(hour),
                sleep: calculateSleepRisk(userState.sleep),
                stress: calculateStressRisk(userState.stress),
                food: calculateFoodRisk(userState.ateToday, userState.calories, userState.sufficientProtein),
                hydration: calculateHydrationRisk(userState.drankToday, userState.fluidOz, userState.includedWater),
                caffeine: calculateCaffeineRisk(userState.caffeine),
                alcohol: calculateAlcoholRisk(userState.alcohol),
                exercise: calculateExerciseRisk(userState.exercise),
                marijuana: calculateMarijuanaRisk(userState.marijuana),
                lightExposure: calculateLightExposureRisk(userState.lightExposure),
                scents: calculateScentsRisk(userState.scents),
                menstrual: calculateMenstrualRisk(userState.menstrualDays, userState.menstrualNotApplicable)
            };

            // Research-based weights (totaling to 1.0)
            const weights = {
                pressure: 0.17,      // High - most studied environmental factor
                humidity: 0.09,      // Medium-high - 28% increase in odds
                temperature: 0.09,   // Medium-high - 19-24% increase
                aqi: 0.06,           // Medium - 3-5% per IQR
                precipitation: 0.04, // Low-medium - related to pressure changes
                wind: 0.02,          // Low - proxy for weather fronts
                time: 0.04,          // Low-medium - circadian patterns
                sleep: 0.13,         // High - major personal trigger
                stress: 0.08,        // Medium-high - cortisol pathway
                food: 0.05,          // Medium - blood sugar trigger
                hydration: 0.05,     // Medium - dehydration trigger
                caffeine: 0.04,      // Medium - withdrawal/overuse
                alcohol: 0.03,       // Low-medium - vasodilation/dehydration
                exercise: 0.03,      // Low-medium - helps or triggers
                marijuana: 0.02,     // Low - complex relationship with migraines
                lightExposure: 0.03, // Low-medium - photosensitivity
                scents: 0.02,        // Low - trigeminal trigger
                menstrual: 0.05      // Medium - hormonal fluctuations
            };

            // Apply sensitivity multiplier based on frequency (1=low sensitivity, 6=extreme sensitivity)
            // Stronger impact: 10+ migraines/month (freq=6) gives 90% higher baseline
            const sensitivityMultiplier = 0.80 + (userState.frequency * 0.20); // Range: 1.0 to 2.0

            // Calculate weighted migraine index
            let migraineIndex = 0;
            for (const factor in factors) {
                migraineIndex += factors[factor] * weights[factor];
            }

            // Apply sensitivity multiplier
            migraineIndex *= sensitivityMultiplier;

            // Clamp to 0-100
            migraineIndex = Math.max(0, Math.min(100, Math.round(migraineIndex)));

            // Update display
            document.getElementById('indexValue').textContent = migraineIndex;
            const marker = document.getElementById('indexMarker');
            marker.style.left = `${migraineIndex}%`;

            // Update risk level text
            const riskText = document.getElementById('riskLevelText');
            if (migraineIndex <= 25) {
                riskText.textContent = 'âœ“ Low Risk - Migraine unlikely in next 12 hours';
                riskText.style.color = '#22c55e';
            } else if (migraineIndex <= 50) {
                riskText.textContent = 'âš  Moderate Risk - Monitor symptoms and stay hydrated';
                riskText.style.color = '#eab308';
            } else if (migraineIndex <= 75) {
                riskText.textContent = 'âš ï¸ High Risk - Migraine likely in next 12 hours, take preventive measures';
                riskText.style.color = '#f97316';
            } else {
                riskText.textContent = 'ðŸš¨ Very High Risk - Take your medication if needed';
                riskText.style.color = '#ef4444';
            }

            // Display individual factors
            displayFactors(factors, weatherData);

            // Generate 12-hour prediction graph
            generate12HourPrediction();
        }

        function generate12HourPrediction() {
            if (!weatherData || !weatherData.forecast12hr || weatherData.forecast12hr.length === 0) {
                document.getElementById('predictionGraphSection').style.display = 'none';
                return;
            }

            // Calculate predicted migraine risk for each hour
            const predictions = weatherData.forecast12hr.map(hourData => {
                // Calculate environmental factor risks for this hour
                const pressure = hourData.pressure_mb;
                const temp = hourData.temp_c;
                const humidity = hourData.humidity;
                const windSpeed = hourData.wind_kph;
                const precipitation = hourData.precip_mm;
                const aqi = hourData.air_quality?.['us-epa-index'] || 1;

                const hourTime = new Date(hourData.time);
                const hour = hourTime.getHours();

                // Use simplified risk calculations for forecast (no historical comparison available)
                const pressureDeviation = Math.abs(pressure - 1013);
                const pressureRisk = Math.min(100, 30 + (pressureDeviation / 15) * 80);

                let tempRisk;
                if (temp >= 18 && temp <= 24) tempRisk = 25;
                else if (temp < 18) tempRisk = Math.min(100, 30 + (18 - temp) * 6);
                else tempRisk = Math.min(100, 30 + (temp - 24) * 5);

                const humidityRisk = humidity > 70 ? Math.min(100, 50 + (humidity - 70) * 1.5) : 30;
                const aqiRiskMap = { 1: 25, 2: 45, 3: 65, 4: 80, 5: 92, 6: 100 };
                const aqiRisk = aqiRiskMap[aqi] || 60;

                let precipRisk = precipitation === 0 ? 30 : precipitation < 5 ? 50 : Math.min(100, 65 + precipitation * 3);
                const windRisk = windSpeed < 10 ? 30 : windSpeed < 20 ? 50 : Math.min(100, 60 + (windSpeed - 20) * 2);
                const timeRisk = (hour >= 4 && hour <= 9) ? 60 : (hour >= 10 && hour <= 15) ? 40 : 35;

                // Personal factors - use current state (we can't predict future personal state)
                const sleepRisk = calculateSleepRisk(userState.sleep);
                const stressRisk = calculateStressRisk(userState.stress);
                const foodRisk = calculateFoodRisk(userState.ateToday, userState.calories, userState.sufficientProtein);
                const hydrationRisk = calculateHydrationRisk(userState.drankToday, userState.fluidOz, userState.includedWater);
                const caffeineRisk = calculateCaffeineRisk(userState.caffeine);
                const alcoholRisk = calculateAlcoholRisk(userState.alcohol);
                const exerciseRisk = calculateExerciseRisk(userState.exercise);
                const marijuanaRisk = calculateMarijuanaRisk(userState.marijuana);
                const lightExposureRisk = calculateLightExposureRisk(userState.lightExposure);
                const scentsRisk = calculateScentsRisk(userState.scents);
                const menstrualRisk = calculateMenstrualRisk(userState.menstrualDays, userState.menstrualNotApplicable);

                // Calculate weighted risk for this hour
                const weights = {
                    pressure: 0.17, humidity: 0.09, temperature: 0.09, aqi: 0.06,
                    precipitation: 0.04, wind: 0.02, time: 0.04, sleep: 0.13,
                    stress: 0.08, food: 0.05, hydration: 0.05, caffeine: 0.04,
                    alcohol: 0.03, exercise: 0.03, marijuana: 0.02, lightExposure: 0.03,
                    scents: 0.02, menstrual: 0.05
                };

                let riskIndex =
                    pressureRisk * weights.pressure +
                    humidityRisk * weights.humidity +
                    tempRisk * weights.temperature +
                    aqiRisk * weights.aqi +
                    precipRisk * weights.precipitation +
                    windRisk * weights.wind +
                    timeRisk * weights.time +
                    sleepRisk * weights.sleep +
                    stressRisk * weights.stress +
                    foodRisk * weights.food +
                    hydrationRisk * weights.hydration +
                    caffeineRisk * weights.caffeine +
                    alcoholRisk * weights.alcohol +
                    exerciseRisk * weights.exercise +
                    marijuanaRisk * weights.marijuana +
                    lightExposureRisk * weights.lightExposure +
                    scentsRisk * weights.scents +
                    menstrualRisk * weights.menstrual;

                // Apply sensitivity multiplier
                const sensitivityMultiplier = 0.80 + (userState.frequency * 0.20);
                riskIndex *= sensitivityMultiplier;
                riskIndex = Math.max(0, Math.min(100, Math.round(riskIndex)));

                return {
                    value: riskIndex / 100, // Normalize to 0-1 for graph coloring
                    label: hourTime.getHours() + 'h'
                };
            });

            // Generate the line graph
            const graphHTML = generateLineGraph(predictions, 600, 120, null);

            // Display the graph
            document.getElementById('predictionGraphContainer').innerHTML = graphHTML;
            document.getElementById('predictionGraphSection').style.display = 'block';
        }

        // Risk calculation functions (return 0-100 scale)
        function calculatePressureRisk(pressure, historyData) {
            // Normal pressure: ~1013 mb. Deviations increase risk
            const deviation = Math.abs(pressure - 1013);
            let risk = Math.min(100, 30 + (deviation / 15) * 80);

            // If we have historical data, factor in rate of change
            // Rapid pressure drops are MUCH more triggering than stable pressure
            if (historyData && historyData.hour && historyData.hour.length > 0) {
                // Get average pressure from 24 hours ago
                const historicalHours = historyData.hour;
                const avgHistoricalPressure = historicalHours.reduce((sum, h) => sum + h.pressure_mb, 0) / historicalHours.length;

                // Calculate 24-hour pressure change
                const pressureChange = pressure - avgHistoricalPressure;
                const pressureDrop = pressureChange < 0 ? Math.abs(pressureChange) : 0;
                const pressureRise = pressureChange > 0 ? pressureChange : 0;

                // Pressure drops are more significant than rises
                // A 10mb drop in 24h is highly triggering
                if (pressureDrop > 0) {
                    risk += Math.min(30, pressureDrop * 3); // Up to +30 risk for drops
                } else if (pressureRise > 5) {
                    risk += Math.min(15, pressureRise * 1.5); // Up to +15 risk for rapid rises
                }
            }

            return Math.min(100, risk);
        }

        function calculateTemperatureRisk(temp, historyData) {
            // Extreme temperatures (very hot or very cold) increase risk
            // Comfortable range: 18-24Â°C
            let risk;
            if (temp >= 18 && temp <= 24) risk = 25;
            else if (temp < 18) risk = Math.min(100, 30 + (18 - temp) * 6);
            else if (temp > 24) risk = Math.min(100, 30 + (temp - 24) * 5);
            else risk = 35;

            // If we have historical data, factor in rapid temperature changes
            if (historyData && historyData.hour && historyData.hour.length > 0) {
                const historicalHours = historyData.hour;
                const avgHistoricalTemp = historicalHours.reduce((sum, h) => sum + h.temp_c, 0) / historicalHours.length;

                // Calculate 24-hour temperature change
                const tempChange = Math.abs(temp - avgHistoricalTemp);

                // Rapid temp changes (>5Â°C in 24h) increase risk
                if (tempChange > 5) {
                    risk += Math.min(20, (tempChange - 5) * 2); // Up to +20 risk
                }
            }

            return Math.min(100, risk);
        }

        function calculateHumidityRisk(humidity) {
            // High humidity (>70%) increases risk, especially in warm seasons
            if (humidity < 50) return 30;
            if (humidity < 70) return 45;
            return Math.min(100, 55 + (humidity - 70) * 2.5);
        }

        function calculateAQIRisk(aqi) {
            // US EPA AQI: 1=Good, 2=Moderate, 3=Unhealthy for sensitive, 4=Unhealthy, 5=Very unhealthy, 6=Hazardous
            const aqiRiskMap = { 1: 25, 2: 45, 3: 65, 4: 80, 5: 92, 6: 100 };
            return aqiRiskMap[aqi] || 60;
        }

        function calculatePrecipitationRisk(precip) {
            // Precipitation often accompanies pressure changes
            if (precip === 0) return 30;
            if (precip < 5) return 50;
            return Math.min(100, 65 + precip * 3);
        }

        function calculateWindRisk(windSpeed) {
            // High winds suggest weather front movement
            if (windSpeed < 10) return 30;
            if (windSpeed < 20) return 50;
            return Math.min(100, 60 + (windSpeed - 20) * 2);
        }

        function calculateTimeRisk(hour) {
            // Migraines more common in early morning (4-9 AM)
            if (hour >= 4 && hour <= 9) return 65;
            if (hour >= 10 && hour <= 15) return 40;
            return 35;
        }

        function calculateSleepRisk(sleepHours) {
            // Sleep in hours: 0-12+
            // Optimal is 7-8 hours = low risk
            // Too little (< 6) or too much (> 9) = higher risk
            if (sleepHours === null) sleepHours = 7; // Default if not filled

            let risk = 0;
            if (sleepHours < 4) risk = 80; // Very little sleep = very high risk
            else if (sleepHours >= 4 && sleepHours < 6) risk = 60; // Poor sleep
            else if (sleepHours >= 6 && sleepHours < 7) risk = 30; // Slightly low
            else if (sleepHours >= 7 && sleepHours <= 8) risk = 10; // Optimal
            else if (sleepHours > 8 && sleepHours <= 9) risk = 30; // Slightly high
            else if (sleepHours > 9 && sleepHours <= 10) risk = 50; // Too much
            else risk = 70; // Excessive sleep (>10 hrs)

            // Adjust based on sleep quality if provided
            if (userState.sleepQuality !== null) {
                const quality = userState.sleepQuality;
                if (quality === 0) risk += 20;      // Awful
                else if (quality === 1) risk += 15; // Terrible
                else if (quality === 2) risk += 10; // Meh
                else if (quality === 3) risk += 0;  // Decent (neutral)
                else if (quality === 4) risk -= 5;  // Good
                else if (quality === 5) risk -= 10; // Excellent
            }

            return Math.max(5, Math.min(95, risk));
        }

        function calculateStressRisk(stress) {
            // Stress contributes but doesn't guarantee migraine
            // Linear relationship but capped contribution
            if (stress === null) stress = 0; // Default if not filled
            return Math.min(70, stress * 6);
        }

        function calculateFoodRisk(ateToday, calories, sufficientProtein) {
            if (ateToday === null || ateToday === false) return 60; // Didn't eat or not filled

            // Base risk if ate today but no details
            let risk = 30;

            // Adjust based on calories if provided
            if (calories && calories !== '') {
                const cal = parseInt(calories);
                if (cal < 800) risk = 70; // Very low calories
                else if (cal < 1200) risk = 50; // Low calories
                else if (cal < 1600) risk = 35; // Slightly low
                else if (cal >= 1600 && cal <= 3000) risk = 15; // Adequate
                else if (cal > 3000) risk = 25; // Excessive
            }

            // Reduce risk if sufficient protein
            if (sufficientProtein && risk > 10) risk -= 10;

            // Add food trigger risk adjustments
            const triggers = userState.foodTriggers;
            if (triggers.chocolate) risk += 8;        // Tyramine + phenylethylamine + caffeine
            if (triggers.agedCheese) risk += 10;      // High tyramine content
            if (triggers.curedMeats) risk += 12;      // Tyramine + nitrites (highest risk)
            if (triggers.pickledFood) risk += 8;      // Histamines
            if (triggers.candy) risk += 7;            // Aspartame + sulfites
            if (triggers.saltySnacks) risk += 9;      // MSG + high sodium
            if (triggers.citrusFruit) risk += 3;      // Lower weight trigger

            return Math.max(10, Math.min(95, risk));
        }

        function calculateHydrationRisk(drankToday, fluidOz, includedWater) {
            if (drankToday === null || drankToday === false) return 65; // Didn't drink or not filled

            // Base risk if drank today but no details
            let risk = 35;

            // Adjust based on fluid oz if provided
            if (fluidOz && fluidOz !== '') {
                const oz = parseInt(fluidOz);
                if (oz < 32) risk = 75; // Severely dehydrated
                else if (oz < 48) risk = 55; // Dehydrated
                else if (oz < 64) risk = 35; // Slightly low
                else if (oz >= 64 && oz <= 100) risk = 15; // Adequate
                else if (oz > 100) risk = 20; // Excessive (possible overhydration)
            }

            // Reduce risk if water was included
            if (includedWater && risk > 10) risk -= 10;

            return Math.max(10, risk);
        }

        function calculateCaffeineRisk(caffeine) {
            // New logic based on regular consumer status and comparison
            if (caffeine === null) {
                // No data filled
                return 20;
            }

            const isRegular = userState.regularCaffeineConsumer;
            const comparison = userState.caffeineComparison;

            // Regular consumer logic
            if (isRegular) {
                if (comparison === 'below') {
                    // Regular consumer + below usual = HIGH risk (withdrawal)
                    return 75;
                } else if (comparison === 'equal') {
                    // Regular consumer + equal to usual = LOW risk (maintained)
                    return 15;
                } else { // above
                    // Regular consumer + above usual = LOW risk (tolerated overuse)
                    return 20;
                }
            } else {
                // Non-regular consumer
                if (caffeine === 0) {
                    return 10; // No caffeine, no risk
                } else if (caffeine <= 200) {
                    // Non-regular + low-moderate caffeine = LOW risk
                    return 20;
                } else if (caffeine <= 400) {
                    // Non-regular + moderate-high caffeine = MEDIUM risk
                    return 40;
                } else {
                    // Non-regular + high caffeine = MEDIUM risk (overstimulation)
                    return 50;
                }
            }
        }

        function calculateAlcoholRisk(alcohol) {
            // Alcohol causes vasodilation, dehydration, disrupts sleep
            // 0-12 drinks slider
            const isRegular = userState.regularAlcoholConsumer;
            const comparison = userState.alcoholComparison;

            if (alcohol === 0) return 10; // No alcohol

            // Base risk increases with amount
            let baseRisk = 20 + (alcohol * 5); // 25-80 range

            // If regular consumer, comparison matters
            if (isRegular) {
                if (comparison === 'less') {
                    baseRisk += 15; // Withdrawal/change risk
                } else if (comparison === 'equal') {
                    baseRisk -= 5; // Maintained tolerance
                } else if (comparison === 'more') {
                    baseRisk += 10; // More than usual
                } else if (comparison === 'farmore') {
                    baseRisk += 30; // FAR more = high risk
                }
            }

            // Red wine and beer are bigger triggers due to histamines and tyramine
            if (userState.containsRedWine) {
                baseRisk += 15; // Red wine contains histamines, tyramine, tannins
            }
            if (userState.containsBeer) {
                baseRisk += 12; // Beer contains histamines and tyramine
            }

            return Math.min(95, Math.max(15, baseRisk));
        }

        function calculateExerciseRisk(exercise) {
            // Moderate exercise helps, intense can trigger
            // 0=none, 1=light, 2=moderate, 3=heavy
            const isRegular = userState.regularExerciser;
            const comparison = userState.exerciseComparison;

            if (exercise === 0) return 20; // No exercise = neutral

            // Base risk: light/moderate beneficial, heavy risky
            const baseRisks = [20, 10, 8, 35]; // none, light, moderate, heavy
            let risk = baseRisks[exercise];

            // If regular exerciser, comparison matters
            if (isRegular) {
                if (comparison === 'less') {
                    risk -= 5; // Less exercise = lower risk (skipping doesn't trigger)
                } else if (comparison === 'equal') {
                    risk -= 3; // Regular routine = good
                } else if (comparison === 'more') {
                    risk += 20; // More than usual can trigger
                } else if (comparison === 'farmore') {
                    risk += 40; // FAR more = overexertion risk
                }
            }

            return Math.min(80, Math.max(5, risk));
        }

        function calculateMarijuanaRisk(marijuana) {
            // Marijuana has complex relationship with migraines
            const isRegular = userState.regularMarijuanaConsumer;
            const comparison = userState.marijuanaComparison;

            if (marijuana === 0) return 15; // No use

            // Base risk increases slightly with amount
            let baseRisk = 18 + (marijuana * 2); // 20-42 range

            // If regular consumer, comparison matters
            if (isRegular) {
                if (comparison === 'less') {
                    baseRisk += 10; // Withdrawal/change risk
                } else if (comparison === 'equal') {
                    baseRisk -= 5; // Maintained use
                } else if (comparison === 'more') {
                    baseRisk += 8; // More than usual
                } else if (comparison === 'farmore') {
                    baseRisk += 20; // FAR more
                }
            }

            return Math.min(70, Math.max(12, baseRisk));
        }

        function calculateLightExposureRisk(lightExposure) {
            // Combine all light sources with different weights
            const sunlight = lightExposure.sunlight || 0;
            const fluorescent = lightExposure.fluorescent || 0;
            const screen = lightExposure.screen || 0;

            // Sunlight is most triggering (bright, UV, glare)
            let sunRisk = Math.min(60, sunlight * 8);

            // Fluorescent is medium triggering (flicker)
            let fluorRisk = Math.min(40, fluorescent * 3);

            // Screen is least triggering but cumulative
            let screenRisk = Math.min(30, screen * 2.5);

            // Combined risk (not simply additive, use max + portion of others)
            const maxRisk = Math.max(sunRisk, fluorRisk, screenRisk);
            const otherRisks = sunRisk + fluorRisk + screenRisk - maxRisk;

            return Math.min(100, maxRisk + (otherRisks * 0.3) + 15);
        }

        function calculateScentsRisk(scents) {
            // Strong scents trigger through trigeminal nerve
            if (scents === 0) return 10;
            if (scents <= 1) return 25;
            if (scents <= 3) return 45;
            if (scents <= 6) return 65;
            return Math.min(100, 75 + (scents - 6) * 3);
        }

        function calculateMenstrualRisk(daysAway, notApplicable) {
            // If not applicable or not filled, return low baseline risk
            if (notApplicable || daysAway === null) return 10;

            // Risk peaks 2 days before through first 3 days
            if (daysAway <= 3) return 65; // During period
            if (daysAway >= 26 && daysAway <= 30) return 70; // 2 days before (assuming 28-day cycle)
            if (daysAway >= 4 && daysAway <= 7) return 40; // Just after
            if (daysAway >= 23 && daysAway <= 25) return 45; // Week before
            return 20; // Mid-cycle
        }

        function getFactorTooltip(factorName, factorValue, weatherData) {
            const current = weatherData.current;
            const history6hr = weatherData.history6hr;
            const history24hr = weatherData.history24hr;
            const forecast6hr = weatherData.forecast6hr;

            switch(factorName) {
                case 'Barometric Pressure':
                    let pressureText = `Current: ${current.pressure_mb} mb`;
                    if (forecast6hr && forecast6hr.length > 0) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + h.pressure_mb, 0) / forecast6hr.length;
                        const predictedChange = avg6hrForecast - current.pressure_mb;
                        pressureText += `\n6hr Future: ${predictedChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(predictedChange).toFixed(1)}mb`;
                    }
                    if (history6hr && history6hr.length > 0) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + h.pressure_mb, 0) / history6hr.length;
                        const change6hr = current.pressure_mb - avg6hr;
                        pressureText += `\n6hr History: ${change6hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change6hr).toFixed(1)}mb`;
                    }
                    if (history24hr && history24hr.length > 0) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + h.pressure_mb, 0) / history24hr.length;
                        const change24hr = current.pressure_mb - avg24hr;
                        pressureText += `\n24hr History: ${change24hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change24hr).toFixed(1)}mb`;
                        if (Math.abs(change24hr) > 5) {
                            pressureText += `\n\nRapid pressure changes are a strong migraine trigger`;
                        }
                    }
                    return pressureText;

                case 'Temperature':
                    let tempText = `Current: ${current.temp_c}Â°C / ${current.temp_f}Â°F`;
                    if (forecast6hr && forecast6hr.length > 0) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + h.temp_c, 0) / forecast6hr.length;
                        const predictedChange = avg6hrForecast - current.temp_c;
                        tempText += `\n6hr Future: ${predictedChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(predictedChange).toFixed(1)}Â°C`;
                    }
                    if (history6hr && history6hr.length > 0) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + h.temp_c, 0) / history6hr.length;
                        const change6hr = current.temp_c - avg6hr;
                        tempText += `\n6hr History: ${change6hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change6hr).toFixed(1)}Â°C`;
                    }
                    if (history24hr && history24hr.length > 0) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + h.temp_c, 0) / history24hr.length;
                        const change24hr = current.temp_c - avg24hr;
                        tempText += `\n24hr History: ${change24hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change24hr).toFixed(1)}Â°C`;
                        if (Math.abs(change24hr) > 5) {
                            tempText += `\n\nRapid temperature changes can trigger migraines`;
                        } else if (current.temp_c >= 18 && current.temp_c <= 24) {
                            tempText += `\n\nTemperature in comfortable range`;
                        } else if (current.temp_c > 30) {
                            tempText += `\n\nHigh heat can trigger migraines through dehydration`;
                        } else if (current.temp_c < 10) {
                            tempText += `\n\nCold temperatures can cause vascular constriction`;
                        }
                    }
                    return tempText;

                case 'Humidity':
                    let humidityText = `Current: ${current.humidity}%`;
                    if (forecast6hr && forecast6hr.length > 0) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + h.humidity, 0) / forecast6hr.length;
                        const predictedChange = avg6hrForecast - current.humidity;
                        humidityText += `\n6hr Future: ${predictedChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(predictedChange).toFixed(0)}%`;
                    }
                    if (history6hr && history6hr.length > 0) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + h.humidity, 0) / history6hr.length;
                        const change6hr = current.humidity - avg6hr;
                        humidityText += `\n6hr History: ${change6hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change6hr).toFixed(0)}%`;
                    }
                    if (history24hr && history24hr.length > 0) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + h.humidity, 0) / history24hr.length;
                        const change24hr = current.humidity - avg24hr;
                        humidityText += `\n24hr History: ${change24hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change24hr).toFixed(0)}%`;
                        if (current.humidity > 70) {
                            humidityText += `\n\nHigh humidity increases migraine risk`;
                        }
                    }
                    return humidityText;

                case 'Air Quality Index':
                    const aqiValue = current.air_quality?.['us-epa-index'] || 1;
                    let aqiText = `Current AQI: ${aqiValue} (${factorValue})`;
                    if (forecast6hr && forecast6hr.length > 0 && forecast6hr[0].air_quality) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + (h.air_quality?.['us-epa-index'] || 1), 0) / forecast6hr.length;
                        const predictedChange = avg6hrForecast - aqiValue;
                        aqiText += `\n6hr Future: ${predictedChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(predictedChange).toFixed(0)}`;
                    }
                    if (history6hr && history6hr.length > 0 && history6hr[0].air_quality) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + (h.air_quality?.['us-epa-index'] || 1), 0) / history6hr.length;
                        const change6hr = aqiValue - avg6hr;
                        aqiText += `\n6hr History: ${change6hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change6hr).toFixed(0)}`;
                    }
                    if (history24hr && history24hr.length > 0 && history24hr[0].air_quality) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + (h.air_quality?.['us-epa-index'] || 1), 0) / history24hr.length;
                        const change24hr = aqiValue - avg24hr;
                        aqiText += `\n24hr History: ${change24hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change24hr).toFixed(0)}`;
                        if (aqiValue > 3) {
                            aqiText += `\n\nPoor air quality increases migraine risk`;
                        }
                    }
                    return aqiText;

                case 'Precipitation':
                    let precipText = `Current: ${current.precip_mm} mm`;
                    if (forecast6hr && forecast6hr.length > 0) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + h.precip_mm, 0) / forecast6hr.length;
                        precipText += `\n6hr Future: ${avg6hrForecast.toFixed(1)} mm`;
                    }
                    if (history6hr && history6hr.length > 0) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + h.precip_mm, 0) / history6hr.length;
                        precipText += `\n6hr History: ${avg6hr.toFixed(1)} mm`;
                    }
                    if (history24hr && history24hr.length > 0) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + h.precip_mm, 0) / history24hr.length;
                        precipText += `\n24hr History: ${avg24hr.toFixed(1)} mm`;
                        precipText += `\n\nRain often accompanies pressure changes`;
                    }
                    return precipText;

                case 'Wind Speed':
                    let windText = `Current: ${current.wind_kph} km/h`;
                    if (forecast6hr && forecast6hr.length > 0) {
                        const avg6hrForecast = forecast6hr.reduce((sum, h) => sum + h.wind_kph, 0) / forecast6hr.length;
                        const predictedChange = avg6hrForecast - current.wind_kph;
                        windText += `\n6hr Future: ${predictedChange > 0 ? 'â†‘' : 'â†“'} ${Math.abs(predictedChange).toFixed(1)} km/h`;
                    }
                    if (history6hr && history6hr.length > 0) {
                        const avg6hr = history6hr.reduce((sum, h) => sum + h.wind_kph, 0) / history6hr.length;
                        const change6hr = current.wind_kph - avg6hr;
                        windText += `\n6hr History: ${change6hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change6hr).toFixed(1)} km/h`;
                    }
                    if (history24hr && history24hr.length > 0) {
                        const avg24hr = history24hr.reduce((sum, h) => sum + h.wind_kph, 0) / history24hr.length;
                        const change24hr = current.wind_kph - avg24hr;
                        windText += `\n24hr History: ${change24hr > 0 ? 'â†‘' : 'â†“'} ${Math.abs(change24hr).toFixed(1)} km/h`;
                        if (current.wind_kph > 24) {
                            windText += `\n\nHigh winds associated with weather systems`;
                        }
                    }
                    return windText;

                case 'Time of Day':
                    const hour = new Date().getHours();
                    let timeText = `Current Time: ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    timeText += `\n\nMigraines are more common in early morning (4-9 AM) due to circadian rhythm factors and cortisol fluctuations.`;
                    if (hour >= 4 && hour <= 9) {
                        timeText += `\n\nYou are currently in the high-risk time window.`;
                    }
                    return timeText;

                case 'Menstrual Cycle':
                    if (userState.menstrualNotApplicable) {
                        return 'Not applicable';
                    }
                    if (userState.menstrualDays === null) {
                        return 'Set in Advanced Mode';
                    }

                    const days = userState.menstrualDays;
                    let menstrualText = `Days until next cycle: ${days}`;

                    // Calculate phase based on days away
                    let phase = '';
                    if (days === 0 || (days >= 26 && days <= 28)) {
                        phase = 'Menstruation (Days 0-5)';
                        menstrualText += `\n\nPhase: ${phase}`;
                        menstrualText += `\nRisk is HIGHEST during this phase`;
                    } else if (days >= 1 && days <= 5) {
                        phase = 'Menstruation (Days 0-5)';
                        menstrualText += `\n\nPhase: ${phase}`;
                        menstrualText += `\nRisk is HIGHEST during this phase`;
                    } else if (days >= 6 && days <= 13) {
                        phase = 'Follicular Phase (Days 6-13)';
                        menstrualText += `\n\nPhase: ${phase}`;
                        menstrualText += `\nRisk is lower during this phase`;
                    } else if (days >= 14 && days <= 16) {
                        phase = 'Ovulation (Days 14-16)';
                        menstrualText += `\n\nPhase: ${phase}`;
                        menstrualText += `\nRisk may vary during ovulation`;
                    } else if (days >= 17 && days <= 25) {
                        phase = 'Luteal Phase (Days 17-28)';
                        menstrualText += `\n\nPhase: ${phase}`;
                        menstrualText += `\nRisk increases in late luteal phase`;
                    }

                    menstrualText += `\n\nHormonal fluctuations are a significant trigger. Risk is highest 2 days before through the first 3 days of menstruation.`;
                    return menstrualText;

                default:
                    return factorValue;
            }
        }

        // Generate color-coded SVG line graph for 12-hour predictions
        function generateLineGraph(dataPoints, width = 200, height = 60, lineColor = null) {
            if (!dataPoints || dataPoints.length < 2) return '';

            const padding = 5;
            const graphWidth = width - (padding * 2);
            const graphHeight = height - (padding * 2);

            // Find min/max for scaling
            const values = dataPoints.map(d => d.value);
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;

            // Generate points for the line
            const points = dataPoints.map((d, i) => {
                const x = padding + (i / (dataPoints.length - 1)) * graphWidth;
                const y = padding + graphHeight - ((d.value - minVal) / range) * graphHeight;
                return { x, y, value: d.value, label: d.label };
            });

            // Generate SVG path
            const pathData = points.map((p, i) =>
                `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
            ).join(' ');

            // Generate colored segments if using risk-based coloring
            let pathElements = '';
            if (lineColor === 'risk') {
                for (let i = 0; i < points.length - 1; i++) {
                    const avgVal = (points[i].value + points[i + 1].value) / 2;
                    const normalizedVal = (avgVal - minVal) / range;
                    // Red for high (> 0.7), Yellow for mid (0.3-0.7), Green for low (< 0.3)
                    let segmentColor = normalizedVal > 0.7 ? '#ef4444' : normalizedVal > 0.3 ? '#eab308' : '#22c55e';
                    pathElements += `<path d="M ${points[i].x} ${points[i].y} L ${points[i + 1].x} ${points[i + 1].y}"
                                          stroke="${segmentColor}" stroke-width="2" fill="none"/>`;
                }
            } else {
                const color = lineColor || '#4CAF50';
                pathElements = `<path d="${pathData}" stroke="${color}" stroke-width="2" fill="none"/>`;
            }

            // Add dots at each point
            const dots = points.map(p =>
                `<circle cx="${p.x}" cy="${p.y}" r="2" fill="#333"/>`
            ).join('');

            return `
                <svg width="${width}" height="${height}" style="display: block;">
                    ${pathElements}
                    ${dots}
                </svg>
            `;
        }

        // Generate dual-line graph for humidity and precipitation
        function generateDualLineGraph(data1, data2, label1, label2, color1, color2, width = 200, height = 60) {
            if (!data1 || data1.length < 2) return '';

            const padding = 5;
            const graphWidth = width - (padding * 2);
            const graphHeight = height - (padding * 2);

            // Combine all values to find global min/max
            const allValues = [...data1.map(d => d.value), ...data2.map(d => d.value)];
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            const range = maxVal - minVal || 1;

            // Generate points for both lines
            const points1 = data1.map((d, i) => {
                const x = padding + (i / (data1.length - 1)) * graphWidth;
                const y = padding + graphHeight - ((d.value - minVal) / range) * graphHeight;
                return { x, y };
            });

            const points2 = data2.map((d, i) => {
                const x = padding + (i / (data2.length - 1)) * graphWidth;
                const y = padding + graphHeight - ((d.value - minVal) / range) * graphHeight;
                return { x, y };
            });

            // Generate paths
            const path1 = points1.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const path2 = points2.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

            return `
                <div style="display: flex; flex-direction: column; gap: 3px;">
                    <svg width="${width}" height="${height}">
                        <path d="${path1}" stroke="${color1}" stroke-width="2" fill="none"/>
                        <path d="${path2}" stroke="${color2}" stroke-width="2" fill="none"/>
                    </svg>
                    <div style="display: flex; gap: 10px; font-size: 10px;">
                        <div><span style="color: ${color1};">â—</span> ${label1}</div>
                        <div><span style="color: ${color2};">â—</span> ${label2}</div>
                    </div>
                </div>
            `;
        }

        function getPressureTrendHTML(weatherData) {
            if (!weatherData.history24hr || weatherData.history24hr.length === 0) {
                return '';
            }

            const current = weatherData.current.pressure_mb;
            const avgHistorical = weatherData.history24hr.reduce((sum, h) => sum + h.pressure_mb, 0) / weatherData.history24hr.length;
            const change = current - avgHistorical;

            if (Math.abs(change) < 3) {
                return '<div class="pressure-trend stable">âœ“ Pressure stable</div>';
            } else if (change < -5) {
                return `<div class="pressure-trend alert">âš ï¸ Pressure dropping rapidly (${Math.abs(change).toFixed(1)}mb in 24h)</div>`;
            } else if (change < 0) {
                return `<div class="pressure-trend warning">âš  Pressure dropping (${Math.abs(change).toFixed(1)}mb in 24h)</div>`;
            } else if (change > 5) {
                return `<div class="pressure-trend warning">âš  Pressure rising rapidly (+${change.toFixed(1)}mb in 24h)</div>`;
            } else {
                return `<div class="pressure-trend stable">âœ“ Pressure rising slowly (+${change.toFixed(1)}mb in 24h)</div>`;
            }
        }

        function displayFactors(factors, weatherData) {
            const container = document.getElementById('factorsContainer');
            const current = weatherData.current;

            // Helper function to get display value and check if filled
            const getSleepDisplay = () => {
                const filled = userState.filledFields.sleep;
                const value = filled ? `${userState.sleep || 7} hrs` : '7 hrs (default)';
                return { value, filled };
            };

            const getStressDisplay = () => {
                const filled = userState.filledFields.stress;
                const value = filled ? `${userState.stress || 0}/10` : '0/10 (default)';
                return { value, filled };
            };

            const getFoodDisplay = () => {
                const filled = userState.filledFields.food;
                let value = 'Not filled out';
                if (filled && userState.ateToday !== null) {
                    if (!userState.ateToday) value = 'None';
                    else if (userState.calories) value = `${userState.calories} cal${userState.sufficientProtein ? ' + protein' : ''}`;
                    else value = 'Ate today';
                }
                return { value, filled };
            };

            const getHydrationDisplay = () => {
                const filled = userState.filledFields.hydration;
                let value = 'Not filled out';
                if (filled && userState.drankToday !== null) {
                    if (!userState.drankToday) value = 'None';
                    else if (userState.fluidOz) value = `${userState.fluidOz} fl oz${userState.includedWater ? ' (water)' : ''}`;
                    else value = 'Drank today';
                }
                return { value, filled };
            };

            const getCaffeineDisplay = () => {
                const filled = userState.filledFields.caffeine;
                const value = filled ? `${userState.caffeine || 0} mg` : '0 mg (default)';
                return { value, filled };
            };

            const getScreenDisplay = () => {
                const filled = userState.filledFields.screenTime;
                const value = filled ? `${userState.screenTime || 4} hrs` : '4 hrs (default)';
                return { value, filled };
            };

            const getMenstrualDisplay = () => {
                const filled = userState.filledFields.menstrual;
                let value = 'Not filled out';
                if (filled) {
                    if (userState.menstrualNotApplicable) value = 'Not applicable';
                    else if (userState.menstrualDays !== null) value = `${userState.menstrualDays} days`;
                }
                return { value, filled };
            };

            const getAlcoholDisplay = () => {
                const filled = userState.filledFields.alcohol;
                const value = filled ? `${userState.alcohol} drink${userState.alcohol == 1 ? '' : 's'}` : '0 drinks (default)';
                return { value, filled };
            };

            const getExerciseDisplay = () => {
                const filled = userState.filledFields.exercise;
                const labels = ['None', 'Light', 'Moderate', 'Heavy'];
                const value = filled ? labels[userState.exercise] : 'None (default)';
                return { value, filled };
            };

            const getMarijuanaDisplay = () => {
                const filled = userState.filledFields.marijuana;
                const value = filled ? `${userState.marijuana} session${userState.marijuana == 1 ? '' : 's'}` : '0 sessions (default)';
                return { value, filled };
            };

            const getLightExposureDisplay = () => {
                const filled = userState.filledFields.lightExposure;
                const total = userState.lightExposure.sunlight + userState.lightExposure.fluorescent + userState.lightExposure.screen;
                const value = filled ? `${total.toFixed(1)} hrs` : '0 hrs (default)';
                return { value, filled };
            };

            const getScentsDisplay = () => {
                const filled = userState.filledFields.scents;
                const value = filled ? `${userState.scents} hrs` : '0 hrs (default)';
                return { value, filled };
            };

            const sleepInfo = getSleepDisplay();
            const stressInfo = getStressDisplay();
            const foodInfo = getFoodDisplay();
            const hydrationInfo = getHydrationDisplay();
            const caffeineInfo = getCaffeineDisplay();
            const alcoholInfo = getAlcoholDisplay();
            const exerciseInfo = getExerciseDisplay();
            const marijuanaInfo = getMarijuanaDisplay();
            const lightExposureInfo = getLightExposureDisplay();
            const scentsInfo = getScentsDisplay();
            const menstrualInfo = getMenstrualDisplay();

            const factorDisplays = [
                {
                    name: 'Barometric Pressure',
                    value: `${current.pressure_mb} mb`,
                    risk: factors.pressure,
                    tooltip: 'Atmospheric pressure changes are strongly associated with migraine onset. Rapid changes (especially drops) are more significant than absolute values.',
                    filled: true,
                    subcategories: [
                        {
                            name: 'Wind Speed',
                            value: `${current.wind_kph} km/h`,
                            risk: factors.wind,
                            tooltip: 'Wind speed helps indicate how QUICKLY barometric changes may be happening. High winds and rapid changes suggest moving weather fronts.',
                            filled: true,
                            hasGraph: true,
                            graphType: 'pressure-12hr'
                        }
                    ]
                },
                {
                    name: 'Temperature',
                    value: `${current.temp_c}Â°C / ${current.temp_f}Â°F`,
                    risk: factors.temperature,
                    tooltip: 'Both temperature extremes and rapid changes (5Â°C within 1-3 days) can trigger migraines through vascular mechanisms.',
                    filled: true
                },
                {
                    name: 'Humidity',
                    value: `${current.humidity}%`,
                    risk: factors.humidity,
                    tooltip: 'High humidity (>70%) is associated with 28% higher migraine odds, particularly during warm seasons (April-September).',
                    filled: true,
                    subcategories: [
                        {
                            name: 'Precipitation',
                            value: `${current.precip_mm} mm`,
                            risk: factors.precipitation,
                            tooltip: 'Precipitation often accompanies pressure changes and weather fronts, which can trigger migraines. The type and intensity matter.',
                            filled: true,
                            hasGraph: true,
                            graphType: 'humidity-precip-dual'
                        },
                        {
                            name: 'Air Quality Index',
                            value: getAQILabel(current.air_quality?.['us-epa-index'] || 1),
                            risk: factors.aqi,
                            tooltip: 'Air pollutants (PM2.5, NO2, O3) increase migraine risk by 3-5% per increment. Particulate matter effects are stronger on high-temperature days.',
                            filled: true
                        }
                    ]
                },
                {
                    name: 'Time of Day',
                    value: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    risk: factors.time,
                    tooltip: 'Migraines are more common in early morning (4-9 AM) due to circadian rhythm factors and cortisol fluctuations.',
                    filled: true
                },
                {
                    name: 'Sleep Quality',
                    value: sleepInfo.value,
                    risk: factors.sleep,
                    tooltip: 'Poor sleep quality increases oxidative stress and cortisol, making you more vulnerable. Both sleep deprivation and excessive sleep can trigger migraines.',
                    filled: sleepInfo.filled
                },
                {
                    name: 'Stress Level',
                    value: stressInfo.value,
                    risk: factors.stress,
                    tooltip: 'Stress elevates cortisol and causes inflammation/brain sensitivity. However, high stress alone doesn\'t guarantee a migraine - it\'s one contributing factor.',
                    filled: stressInfo.filled
                },
                {
                    name: 'Food Intake',
                    value: foodInfo.value,
                    risk: factors.food,
                    tooltip: 'Skipping meals or inadequate food intake causes blood sugar drops, which are a common migraine trigger.',
                    filled: foodInfo.filled
                },
                {
                    name: 'Hydration',
                    value: hydrationInfo.value,
                    risk: factors.hydration,
                    tooltip: 'Dehydration is a well-known migraine trigger. Even mild dehydration can trigger headaches and migraines.',
                    filled: hydrationInfo.filled
                },
                {
                    name: 'Caffeine Intake',
                    value: caffeineInfo.value,
                    risk: factors.caffeine,
                    tooltip: 'Caffeine has a complex relationship with migraines. It can help treat them, but overuse (>400mg/day) or withdrawal in regular users can trigger them.',
                    filled: caffeineInfo.filled
                },
                {
                    name: 'Alcohol (24hrs)',
                    value: alcoholInfo.value,
                    risk: factors.alcohol,
                    tooltip: 'Alcohol causes vasodilation and dehydration, both of which can trigger migraines. Even moderate amounts can be problematic.',
                    filled: alcoholInfo.filled
                },
                {
                    name: 'Exercise (24hrs)',
                    value: exerciseInfo.value,
                    risk: factors.exercise,
                    tooltip: 'Exercise has a complex relationship with migraines. Regular moderate exercise is protective, but intense exercise or overexertion can trigger attacks.',
                    filled: exerciseInfo.filled
                },
                {
                    name: 'Marijuana (24hrs)',
                    value: marijuanaInfo.value,
                    risk: factors.marijuana,
                    tooltip: 'Marijuana has a complex relationship with migraines. Some find relief, while others experience triggers. Individual responses vary significantly.',
                    filled: marijuanaInfo.filled
                },
                {
                    name: 'Light Exposure Today',
                    value: lightExposureInfo.value,
                    risk: factors.lightExposure,
                    tooltip: 'Bright light, especially sunlight, fluorescent lighting, and screen glare, can trigger migraines in photosensitive individuals.',
                    filled: lightExposureInfo.filled
                },
                {
                    name: 'Strong Scents Exposure',
                    value: scentsInfo.value,
                    risk: factors.scents,
                    tooltip: 'Strong odors (perfumes, cleaning products, smoke) can trigger migraines through trigeminal nerve activation.',
                    filled: scentsInfo.filled
                },
                {
                    name: 'Menstrual Cycle',
                    value: menstrualInfo.value,
                    risk: factors.menstrual,
                    tooltip: 'Hormonal fluctuations are a significant trigger. Risk is highest 2 days before through the first 3 days of menstruation.',
                    filled: menstrualInfo.filled
                }
            ];

            // Helper function to render a single factor (parent or subcategory)
            const renderFactor = (factor, isSubcategory = false) => {
                const isSleep = factor.name === 'Sleep Quality';
                const tooltipText = getFactorTooltip(factor.name, factor.value, weatherData);
                const pressureTrend = factor.name === 'Barometric Pressure' ? getPressureTrendHTML(weatherData) : '';
                const hasTooltip = tooltipText && tooltipText.trim() !== '';

                const scaleHTML = isSleep
                    ? generateSleepBlockScale(userState.sleep, !factor.filled)
                    : `<div class="factor-scale">
                        <div class="factor-marker" style="left: ${factor.risk}%">
                            ${hasTooltip ? `<div class="factor-marker-tooltip">${tooltipText}${!factor.filled ? '<br><br><em>Set in Advanced Mode</em>' : ''}</div>` : (!factor.filled ? '<div class="factor-marker-tooltip"><em>Set in Advanced Mode</em></div>' : '')}
                        </div>
                       </div>`;

                // Add factor-specific class for styling
                const factorClass = factor.name.toLowerCase().replace(/\s+/g, '-');

                // Generate graph if this factor has one
                let graphHTML = '';
                if (factor.hasGraph && weatherData.forecast12hr) {
                    if (factor.graphType === 'pressure-12hr') {
                        const pressureData = weatherData.forecast12hr.map(h => ({ value: h.pressure_mb, label: new Date(h.time).getHours() + 'h' }));
                        graphHTML = generateLineGraph(pressureData, 200, 60, '#4CAF50');
                    } else if (factor.graphType === 'humidity-precip-dual') {
                        const humidityData = weatherData.forecast12hr.map(h => ({ value: h.humidity }));
                        const precipData = weatherData.forecast12hr.map(h => ({ value: h.precip_mm }));
                        graphHTML = generateDualLineGraph(humidityData, precipData, 'Humidity %', 'Precip mm', '#4CAF50', '#2196F3', 200, 60);
                    }
                }

                // Determine if this factor should be split (half-width with graph)
                const hasSplit = factor.hasGraph && graphHTML;

                const factorContent = `
                    <div class="factor-header">
                        <span class="factor-name">
                            ${factor.name}
                            <span class="info-icon">?
                                <span class="tooltip">${factor.tooltip}</span>
                            </span>
                        </span>
                        <div>
                            <div class="factor-value-container">
                                <div class="factor-value-label">Currently:</div>
                                <div class="factor-value">${factor.value}</div>
                            </div>
                            <div class="factor-value-underline"></div>
                        </div>
                    </div>
                    ${isSubcategory ? '' : pressureTrend}
                    ${scaleHTML}
                    ${!factor.filled ? '<div class="factor-prompt">Click to fill out in Advanced Mode</div>' : ''}
                `;

                if (hasSplit) {
                    return `
                        <div class="factor-split">
                            <div class="factor-split-left">
                                ${factorContent}
                            </div>
                            <div class="factor-split-right">
                                ${graphHTML}
                            </div>
                        </div>
                    `;
                } else {
                    return factorContent;
                }
            };

            container.innerHTML = factorDisplays.map(factor => {
                const factorClass = factor.name.toLowerCase().replace(/\s+/g, '-');
                const mainFactorHTML = renderFactor(factor);

                // Render subcategories if they exist
                let subcategoriesHTML = '';
                if (factor.subcategories && factor.subcategories.length > 0) {
                    subcategoriesHTML = `
                        <div class="factor-subcategories">
                            ${factor.subcategories.map(sub => {
                                const subClass = sub.name.toLowerCase().replace(/\s+/g, '-');
                                return `
                                    <div class="factor-subcategory factor-${subClass} ${!sub.filled ? 'greyed-out' : ''}" ${!sub.filled ? 'onclick="openAdvancedMode()"' : ''}>
                                        ${renderFactor(sub, true)}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="factor-item factor-${factorClass} ${!factor.filled ? 'greyed-out' : ''}" ${!factor.filled ? 'onclick="openAdvancedMode()"' : ''}>
                        ${mainFactorHTML}
                        ${subcategoriesHTML}
                    </div>
                `;
            }).join('');
        }

        function generateSleepBlockScale(sleepValue, isGreyedOut) {
            if (sleepValue === null) sleepValue = 7;

            // Define the 32 blocks with their colors and values
            const blocks = [];

            // 0-3 hrs = red (7 blocks)
            for (let i = 0; i <= 3; i += 0.5) blocks.push({ value: i, color: 'red' });

            // 3.5-5.5 hrs = yellow (5 blocks)
            for (let i = 3.5; i <= 5.5; i += 0.5) blocks.push({ value: i, color: 'yellow' });

            // 6-9.5 hrs = green (8 blocks)
            for (let i = 6; i <= 9.5; i += 0.5) blocks.push({ value: i, color: 'green' });

            // 10-12 hrs = yellow (5 blocks)
            for (let i = 10; i <= 12; i += 0.5) blocks.push({ value: i, color: 'yellow' });

            // 12.5-15+ hrs = red (7 blocks) - note: 15+ is represented as 15
            for (let i = 12.5; i <= 15; i += 0.5) blocks.push({ value: i, color: 'red' });

            return `<div class="sleep-block-scale">
                ${blocks.map(block => `
                    <div class="sleep-block ${isGreyedOut ? 'grey' : block.color} ${block.value === sleepValue ? 'active' : ''}"></div>
                `).join('')}
            </div>`;
        }

        function getAQILabel(aqi) {
            const labels = {
                1: 'Good',
                2: 'Moderate',
                3: 'Unhealthy (Sensitive)',
                4: 'Unhealthy',
                5: 'Very Unhealthy',
                6: 'Hazardous'
            };
            return labels[aqi] || 'Unknown';
        }
    </script>
</body>
</html>
